<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tug&#39;s Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tug&#39;s Site Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-1520374-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Blog | Tug&#x27;s Site</title><meta data-react-helmet="true" property="og:title" content="Blog | Tug&#x27;s Site"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://tgrall.github.io/blog/page/4"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tgrall.github.io/blog/page/4"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/page/4" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/page/4" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.48522199.css">
<link rel="preload" href="/assets/js/runtime~main.4b9fad76.js" as="script">
<link rel="preload" href="/assets/js/main.ea67b1c9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Tug&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://windr.org" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Windsurfing App<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/tgrall/tgrall.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/02/08/getting-started-with-github-releases">Getting Started with GitHub Releases</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2022/01/24/share-private-actions-enterprise">Use Private Actions with your Team</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/07/how-to-write-a-github-action-annotation-api">Write GitHub Action: Checks and Annotations API (Part 2)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/30/how-to-write-a-github-action">How to Write Custom GitHub Action (Part 1)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/05/16/simple-caching-service-with-redis">Simple caching service with Redis</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2014/08/21/introduction-to-mongodb-geospatial-feature">Introduction to MongoDB Geospatial feature</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-08-21T00:00:00.000Z" itemprop="datePublished">August 21, 2014</time> · 9 min read</div></header><div class="markdown" itemprop="articleBody"><p>This post is a quick and simple introduction to Geospatial feature of MongoDB 2.6 using simple dataset and queries.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="storing-geospatial-informations"></a>Storing Geospatial Informations<a class="hash-link" href="#storing-geospatial-informations" title="Direct link to heading">#</a></h3><p>As you know you can store any type of data, but if you want to query them you need to use some coordinates, and create index on them. MongoDB supports three types of indexes for GeoSpatial queries:</p><ul><li><a href="http://docs.mongodb.org/manual/core/2d/" target="_blank" rel="noopener noreferrer">2d Index</a> : uses simple coordinate (longitude, latitude). As stated in the documentation: <em>The 2d index is intended for legacy coordinate pairs used in MongoDB 2.2 and earlier</em>. For this reason, I won&#x27;t detail anything about this in this post. Just for the record 2d Index are used to query data stored as points on a two-dimensional plane</li><li><a href="http://docs.mongodb.org/manual/core/2dsphere/" target="_blank" rel="noopener noreferrer">2d Sphere Index</a> : support queries of any geometries on an-earth-like sphere, the data can be stored as GeoJSON and legacy coordinate pairs (longitude, latitude). For the rest of the article I will use this type of index and focusing on GeoJSON.</li><li><a href="http://docs.mongodb.org/manual/core/geohaystack/" target="_blank" rel="noopener noreferrer">Geo Haystack</a> : that are used to query on very small area. It is today less used by applications and I will not describe it in this post.
So this article will focus now on the 2d Sphere index with GeoJSON format to store and query documents.</li></ul><p><em>So what is GeoJSON?</em></p><p>You can look at the <a href="http://geojson.org/" target="_blank" rel="noopener noreferrer">http://geojson.org/</a> site, let&#x27;s do a very short explanation. GeoJSON is a format for encoding, in JSON, a variety of geographic data structures, and support the following types:  Point , LineString , Polygon , MultiPoint , MultiLineString , MultiPolygon and Geometry.</p><p>The GeoJSON format  is quite straightforward based, for the simple geometries, on two attributes: type and coordinates. Let&#x27;s take some examples:</p><p>The city where I spend all my childhood, Pleneuf Val-André, France, has the following coordinates (from Wikipedia)</p><p><code>48° 35′ 30.12″ N, 2° 32′ 48.84″ W</code></p><p>This notation is a point, based on a latitude &amp; longitude using the <a href="http://en.wikipedia.org/wiki/World_Geodetic_System" target="_blank" rel="noopener noreferrer">WGS 84</a> (Degrees, Minutes, Seconds) system. Not very easy to use by application/code, this is why it is also possible to represent the exact same point using the following values for latitude &amp; longitude:</p><p><code>48.5917, -2.5469</code></p><p>This one uses the <a href="http://en.wikipedia.org/wiki/World_Geodetic_System" target="_blank" rel="noopener noreferrer">WGS 84</a> (Decimal Degrees) system. This is the coordinates you see use in most of the application/API you are using as developer (eg: Google Maps/Earth for example)</p><p>By default GeoJSON, and MongoDB use these values but <strong>the coordinates must be stored in the longitude, latitude order</strong>, so this point in GeoJSON will look like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Point&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;coordinates&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">-2.5469</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">48.5917</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><img src="http://2.bp.blogspot.com/-0GfvAvSgLM8/U_NwAR_BCpI/AAAAAAAAArI/INweKtutfDQ/s1600/01-geojson-point.png"></p><p>This is a simple &quot;Point&quot;, let&#x27;s now for example look at a line, a very nice walk on the beach :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LineString&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;coordinates&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">-2.551082</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">48.5955632</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">-2.551229</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">48.594312</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">-2.551550</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">48.593312</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">-2.552400</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">48.592312</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">-2.553677</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">48.590898</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><a href="http://1.bp.blogspot.com/-dg_myaJAG-c/U_Nv80jrncI/AAAAAAAAArA/utmCcBlQeqY/s1600/02-geojson-linestring.png" target="_blank" rel="noopener noreferrer">http://1.bp.blogspot.com/-dg_myaJAG-c/U_Nv80jrncI/AAAAAAAAArA/utmCcBlQeqY/s1600/02-geojson-linestring.png</a> )</p><p>So using the same approach you will be able to create MultiPoint, MultiLineString, Polygon, MultiPolygon. It is also possible to mix all these in a single document using a GeometryCollection. The following example is a Geometry Collection of MultiLineString and Polygon over Central Park:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GeometryCollection&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;geometries&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Polygon&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;coordinates&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.9580</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.8003</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.9498</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.7968</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.9737</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.7648</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.9814</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.7681</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.9580</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.8003</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MultiLineString&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;coordinates&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.96943</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.78519</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.96082</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.78095</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.96415</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.79229</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.95544</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.78854</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.97162</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.78205</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.96374</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.77715</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.97880</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.77247</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">-73.97036</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.76811</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><img src="http://3.bp.blogspot.com/-tIxoUIeSMWw/U_SUsEJ_EDI/AAAAAAAAArY/2qelBrB1xRY/s1600/03-gejson-collection.png"></p><p>Note: You can if you want test/visualize these JSON documents using the <a href="http://geojsonlint.com/" target="_blank" rel="noopener noreferrer">http://geojsonlint.com/</a> service.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor anchor__h5 anchorWithStickyNavbar_31ik" id="now-what-lets-store-data"></a>Now what? Let&#x27;s store data!<a class="hash-link" href="#now-what-lets-store-data" title="Direct link to heading">#</a></h5><p>Once you have a GeoJSON document you just need to store it into your document. For example if you want to store a document about JFK Airport with its location you can run the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">airports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;John F Kennedy Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JFK&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;loc&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Point&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;coordinates&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">73.778889</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">40.639722</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Yes this is that simple! You just save the GeoJSON as one of the attribute of the document, <code>loc</code> in this example)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="querying-geospatial-informations"></a>Querying Geospatial Informations<a class="hash-link" href="#querying-geospatial-informations" title="Direct link to heading">#</a></h3><p>Now that we have the data stored in MongoDB, it is now possible to use the geospatial information to do some interesting queries.</p><p>For this we need a sample dataset. I have created one using some open data found in various places. This dataset contains the following informations:</p><ul><li>airports collection with the list of US airport (Point)</li><li>states collection with the list of US states (MultiPolygon)</li></ul><p>I have created this dataset from various OpenData sources ( <a href="http://geocommons.com/" target="_blank" rel="noopener noreferrer">http://geocommons.com/</a> , <a href="http://catalog.data.gov/dataset" target="_blank" rel="noopener noreferrer">http://catalog.data.gov/dataset</a> ) and use <a href="https://github.com/mapbox/togeojson" target="_blank" rel="noopener noreferrer">toGeoJSON</a> to convert them into the proper format.</p><p>Let&#x27;s install the dataset:</p><ol><li>Download it from <a href="https://www.dropbox.com/s/yui7shcud2xbxt7/geo.zip" target="_blank" rel="noopener noreferrer">here</a></li><li>Unzip geo.zip file</li><li>Restore the data into your mongoDB instance, using the following command</li></ol><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">mongorestore geo.zip</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>MongoDB allows applications to do the following types of query on geospatial data:</p><ul><li>inclusion</li><li>intersection</li><li>proximity</li></ul><p>Obviously, you will be able to use all the other operator in addition to the geospatial ones. Let&#x27;s now look at some concrete examples.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="inclusion"></a>Inclusion<a class="hash-link" href="#inclusion" title="Direct link to heading">#</a></h4><p>Find all the airports in California. For this you need to get the California location (Polygon) and use the command $geoWithin in the query. From the shell it will look like :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">use geo</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> cal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CA&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">airports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  loc </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geoWithin </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geometry </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Result:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Modesto City - County&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;MOD&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Francisco Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SFO&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Jose International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SJC&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So the query is using the &quot;California MultiPolygon&quot; and looks in the airports collection to find all the airports that are in these polygons. This looks like the following image on a map:</p><p><img src="http://1.bp.blogspot.com/-AO6C6fgsrYQ/U_Wyr2RHPWI/AAAAAAAAAro/hVn6YFJQtNI/s1600/04-geojson-cal-airport.png"></p><p>You can use any other query features or criteria, for example you can limit the query to international airport only sorted by name :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">airports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  loc </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geoWithin </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geometry </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loc</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  type </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> type </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">sort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Result:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Los Angeles Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LAX&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Metropolitan Oakland Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;OAK&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Ontario Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ONT&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Diego Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SAN&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Francisco Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SFO&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Jose International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SJC&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Southern California International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VCV&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I do not know if you have looked in detail, but we are querying these documents with no index. You can run a query with the <code>explain()</code> to see what&#x27;s going on. The <code>$geoWithin</code> operator does not need index but your queries will be more efficient with one so let&#x27;s create the index:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">airports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">ensureIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;loc&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2dsphere&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Run the explain and you will se the difference.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="intersection"></a>Intersection<a class="hash-link" href="#intersection" title="Direct link to heading">#</a></h4><p>Suppose you want to know what are all the adjacent states to California, for this we just need to search for all the states that have coordinates that &quot;intersects&quot; with California. This is done with the following query:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> cal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">findOne</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CA&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  loc </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geoIntersects </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $geometry </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> cal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">loc</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> $ne </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;CA&quot;</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _id </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Result:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Oregon&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;OR&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Nevada&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;NV&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Arizona&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;AZ&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><img src="http://3.bp.blogspot.com/--Kh1AzmsaSU/U_XreY-tRlI/AAAAAAAAAr4/cS1pgjgF2Pc/s1600/05-geojson-intersect.png"></p><p>Same as before <code>$geoIntersect</code> operator does not need an index to work, but it will be more efficient with the following index:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">states</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">ensureIndex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> loc </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2dsphere&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="proximity"></a>Proximity<a class="hash-link" href="#proximity" title="Direct link to heading">#</a></h4><p>The last feature that I want to highlight in this post is related to query with proximity criteria. Let&#x27;s find all the international airports that are located at less than 20km from the reservoir in NYC Central Park. For this you will be using the <code>$near</code> operator.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">airports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  loc </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $near </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      $geometry </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        type </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Point&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        coordinates </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">73.965355</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">40.782865</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      $maxDistance </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20000</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  type </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;International&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  name </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  code </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  _id </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Results:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;La Guardia&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;LGA&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Newark Intl&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;code&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;EWR&quot;</span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So this query returns 2 airports, the closest being La Guardia, since the <code>$near</code> operator sorts the results by distance. Also it is important to raise here that the <code>$near</code> operator requires an index.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>In this first post about geospatial feature you have learned:</p><ul><li>the basic of GeoJSON</li><li>how to query documents with inclusion, intersection and proximity criteria.</li></ul><p>You can now play more with this for example integrate this into an application that expose data into some UI, or see how you can use the geospatial operators into a aggregation pipeline.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2014/03/28/dbpersonfind-role-dba">db.person.find( { &#x27;role&#x27; : &#x27;DBA&#x27; } )</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2014-03-28T00:00:00.000Z" itemprop="datePublished">March 28, 2014</time> · 6 min read</div></header><div class="markdown" itemprop="articleBody"><p>Wow! it has been a while since I posted something on my blog post. I have been very busy, moving to MongoDB, learning, learning, learning…finally I can breath a little and answer some questions.</p><p>Last week I have been helping my colleague Norberto to deliver a MongoDB Essentials Training in Paris. This was a very nice experience, and I am impatient to deliver it on my own. I was happy to see that the audience was well balanced between developers and operations, mostly DBA.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="what-i-still-need-dba"></a>What! I still need DBA?<a class="hash-link" href="#what-i-still-need-dba" title="Direct link to heading">#</a></h3><p><img src="http://ct.fra.bz/ol/fz/sw/i53/5/6/8/frabz-what-if-i-told-you-you-dont-need-to-know-sql-to-be-a-dba-85380e.jpg"></p><p>This is a good opportunity to raise a point, or comment a wrong idea: the fact that you are using MongoDB, or any other NoSQL datastore does not mean that you do not need a DBA… Like any project, an administrator is not mandatory, but if you have one it is better. So even when MongoDB is pushed by development team it is very important to understand the way the database works, and how to administer, monitor it.</p><p>If you are lucky enough to have real operations teams, with good system and database administrators use them! They are very important for your application.</p><p>Most DBA/System Administrators have been maintaining systems in production for many years. They know how to keep your application up and running. They also most of the time experienced many “disasters”, and then recover (I hope).</p><p>Who knows, you may encounter big issues with your application and you will be happy to have them on your side at this moment.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="great-but-the-dba-is-slowing-down-my-development"></a>&quot;Great, but the DBA is slowing down my development!&quot;<a class="hash-link" href="#great-but-the-dba-is-slowing-down-my-development" title="Direct link to heading">#</a></h3><p>I hear this, sometimes, and I had this feeling in the past to as developer in large organization. Is it true?</p><p>Developers and DBA are today, not living in the same worlds:</p><ul><li>Developers want to integrate new technologies as soon as possible, not only because it is fun and they can brag about it during meetups/conferences; but because these technologies, most of the time, are making them more productive, and offer better service/experience to the consumer</li><li>DBA, are here to keep the applications up and running! So every time they do not feel confident about a technology they will push back. I think this is natural and I would be probably the same in their position. Like all geeks, they would love to adopt new technologies but they need to understand and trust it before.</li></ul><p>System administrators, DBAS look at the technology with a different angle than developers.</p><p>Based on this assumption, it is important to bring the operation team as early as possible when  the development team wants to integrate MongoDB or any new data store. Having the operation team in the loop early will ease the global adoption of MongoDB in the company.</p><p>Personally, and this will show my age, I have seen a big change in the way developers and DBAs are working together.</p><p>Back in the 90&#x27;s, when the main architecture was based on client/server architecture  developers and DBAs where working pretty well togethers; probably because they were speaking the same language: SQL was everywhere.  I had regular meetings wit</p><p>Then, since mid 2000, mots of applications have moved to a web based architecture , with for example Java middleware, and the developers stopped working with DBAs. Probably because the abstraction data layer provided by the ORM exposed the database as a &quot;commodity&quot; service that is supposed to work: &quot;Hey Mr DBA, my application has been written with the best middleware technology on the market, so now deal with the performance and scalability! I am done!&quot;</p><p>Yes it is a cliché, but I am sure that some of you will recognize that.</p><p>Nevertheless each time I can, I have been pushing developers to talk more to administrators and look closely to their database!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="a-new-era-for-operations-and-development-teams"></a>A new era for operations and development teams<a class="hash-link" href="#a-new-era-for-operations-and-development-teams" title="Direct link to heading">#</a></h3><p>The fast adoption of MongoDB by developers, is a great opportunity to fix what we have broken 10 years ago in large information systems:</p><ul><li>Let&#x27;s talk again!</li></ul><p>MongoDB has been built first for developers. The document oriented approach gives lot of flexibility to quickly adapt to change. So anytime your business users need a new feature you can implement it, even if this change impact the data structure. Your data model is now driven and controlled by the application, not the database engine.</p><p>However, the applications still need to be available 24x7, and performs well. These topics are managed - and shared- by administrator and developers! This has been always the case but, as I described it earlier, it looks like some of us have forgotten that.</p><p>Schemas design, change velocity, are driven by the application, so the business and development teams, but all this impacts the database, for example:</p><ul><li>How storage will grow ?</li><li>Which indexes must be created to speed up my application?</li><li>How to organize my cluster to leverage the infrastructure properly:<ul><li>Replica-Set organization (and related write concerns, managed by developer)</li><li>Sharding options</li></ul></li><li>And the most important of them : backup/recovery strategies</li></ul><p>So many things that could be managed by the project team, but if you have an operation team with you, it will be better to do that as a single team.</p><p>You, the developer, are convinced that MongoDB is the best database for your projects! Now it is time to work with the ops team and convince them too.  So you should for sure explain why MongoDB is good for you as developer, but also you should highlight all the benefits for the operations, starting with built-in high-availability with replica sets, and easy scalability with sharding. MongoDB is also here to make the life of the administrator easier! I have shared in the next paragraph a lit of resources that are interesting for operations people.</p><p>Let’s repeat it another time, try to involve the operation team as soon as possible, and use that as an opportunity to build/rebuild the relationship between developers and system administrators!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="resources"></a>Resources<a class="hash-link" href="#resources" title="Direct link to heading">#</a></h3><p>You can find many good resources on the Site to helps operations or learn about this:</p><ul><li>Documentation : <a href="http://docs.mongodb.org/manual/administration/" target="_blank" rel="noopener noreferrer">Operations</a></li><li>Online Training :<ul><li><a href="https://education.mongodb.com/courses/10gen/M102/2014_May/about" target="_blank" rel="noopener noreferrer">M102: MongoDB for DBAs</a></li><li><a href="https://education.mongodb.com/courses/10gen/M202/2014_April/about" target="_blank" rel="noopener noreferrer">M202: MongoDB Advanced Deployment and Operations</a></li></ul></li><li>And many others such as White Papers and <a href="http://www.mongodb.com/webinars" target="_blank" rel="noopener noreferrer">Webinars</a>.</li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/10/01/pagination-with-couchbase">Pagination with Couchbase</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-10-01T00:00:00.000Z" itemprop="datePublished">October 1, 2013</time> · 7 min read</div></header><div class="markdown" itemprop="articleBody"><p>If you have to deal with a large number of documents when doing queries against a Couchbase cluster it is important to use pagination to get rows by page. You can find some information in the documentation in the chapter &quot;<a href="http://docs.couchbase.com/couchbase-manual-2.2/#pagination" target="_blank" rel="noopener noreferrer">Pagination</a>&quot;, but I want to go in more details and sample code in this article.</p><p>For this example I will start by creating a simple view based on the <code>beer-sample</code> dataset, the view is used to find brewery by country:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">doc</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> meta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;brewery&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">amp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">amp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">country</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">country</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This view list all the breweries by country, the index looks like:</p><table><tbody><tr><th>Doc id</th><th>Key</th><th>Value</th></tr><tr><td>bersaglier</td><td>Argentina</td><td>null</td></tr><tr><td>cervecera_jerome</td><td>Argentina</td><td>null</td></tr><tr><td>brouwerij_nacional_balashi</td><td>Aruba</td><td>null</td></tr><tr><td>australian_brewing_corporation</td><td>Australia</td><td>null</td></tr><tr><td>carlton_and_united_breweries</td><td>Australia</td><td>null</td></tr><tr><td>coopers_brewery</td><td>Australia</td><td>null</td></tr><tr><td>foster_s_australia_ltd</td><td>Australia</td><td>null</td></tr><tr><td>gold_coast_brewery</td><td>Australia</td><td>null</td></tr><tr><td>lion_nathan_australia_hunter_street</td><td>Australia</td><td>null</td></tr><tr><td>little_creatures_brewery</td><td>Australia</td><td>null</td></tr><tr><td>malt_shovel_brewery</td><td>Australia</td><td>null</td></tr><tr><td>matilda_bay_brewing</td><td>Australia</td><td>null</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>yellowstone_valley_brewing</td><td>United States</td><td>null</td></tr><tr><td>yuengling_son_brewing</td><td>United States</td><td>null</td></tr><tr><td>zea_rotisserie_and_brewery</td><td>United States</td><td>null</td></tr><tr><td>fosters_tien_gang</td><td>Viet Nam</td><td>null</td></tr><tr><td>hue_brewery</td><td>Viet Nam</td><td>null</td></tr></tbody></table><p>So now you want to navigate in this index with a page size of 5 rows.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="using-skip--limit-parameters"></a>Using skip / limit Parameters<a class="hash-link" href="#using-skip--limit-parameters" title="Direct link to heading">#</a></h3><p>The most simplistic approach is to use <code>limit</code> and <code>skip</code> parameters for example:</p><p>Page 1 : <code>?limit=5&amp;amp;skip0</code><br>
Page 2 : <code>?limit=5&amp;amp;skip=5</code>
...
Page x : <code>?limit=5&amp;amp;skip(limit*(page-1))</code></p><p>You can obviously use any other parameters you need to do range or key queries (<code>startkey/endkey, key, keys</code>) and sort option (<code>descending</code>).</p><p>This is simple but not the most efficient way, since the query engine has to read all the rows that match the query, until the skip value is reached.</p><p>Some code sample in python that paginate using this view :</p><iframe width="100%" frameborder="0" id="gist-6174762"></iframe><p>This application loops on all the pages until the end of the index.</p><p>As I said before this is not the best approach since the system must read all the values until the skip is reached. The following example shows a better way to deal with this.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="using-startkey--startkey_docid-parameters"></a>Using startkey / startkey_docid parameters<a class="hash-link" href="#using-startkey--startkey_docid-parameters" title="Direct link to heading">#</a></h3><p>To make this pagination more efficient it is possible to take another approach. This approach uses the  <code>startkey</code> and <code>startkey_docid</code>  to select the proper documents.</p><ul><li><code>The startkey</code> parameter will be the value of the key where the query should start to read (based on the last key of the &quot;previous page&quot;</li><li>Since for a key for example &quot;Germany&quot; you may have one or more ids (documents) it is necessary to say to Couchbase query engine where to start, for this you need to use the <code>startkey_docid</code> parameter, and ignore this id since it is the last one of the previous page.</li></ul><p>So if we look at the index, and add a row number to explain the pagination</p><table><tbody><tr><th>Row num</th><th>Doc id</th><th>Key</th><th>Value</th></tr><tr><td colspan="4"><br>Query for page 1<br>`?limit=5`</td></tr><tr><td>1</td><td></td><td>bersaglier</td><td>Argentina</td><td>null</td></tr><tr><td>2</td><td></td><td>cervecera_jerome</td><td>Argentina</td><td>null</td></tr><tr><td>3</td><td></td><td>brouwerij_nacional_balashi</td><td>Aruba</td><td>null</td></tr><tr><td>4</td><td></td><td>australian_brewing_corporation</td><td>Australia</td><td>null</td></tr><tr><td>5</td><td></td><td>carlton_and_united_breweries</td><td>Australia</td><td>null</td></tr><tr><td colspan="4">Query for page 2<br>`?limit=5&amp;startkey=&quot;Australia&quot;&amp;startkey_docid=carlton_and_united_breweries&amp;skip=1`</td></tr><tr><td>6</td><td></td><td>coopers_brewery</td><td>Australia</td><td>null</td></tr><tr><td>7</td><td></td><td>foster_s_australia_ltd</td><td>Australia</td><td>null</td></tr><tr><td>8</td><td></td><td>gold_coast_brewery</td><td>Australia</td><td>null</td></tr><tr><td>9</td><td></td><td>lion_nathan_australia_hunter_street</td><td>Australia</td><td>null</td></tr><tr><td>10</td><td></td><td>little_creatures_brewery</td><td>Australia</td><td>null</td></tr><tr><td colspan="4"><br>Query for page 3<br>`?limit=5&amp;startkey=&quot;Australia&quot;&amp;startkey_docid=little_creatures_brewery``&amp;skip=1`</td></tr><tr><td>11</td><td></td><td>malt_shovel_brewery</td><td>Australia</td><td>null</td></tr><tr><td>12</td><td></td><td>matilda_bay_brewing</td><td>Australia</td><td>null</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td>...</td><td>...</td></tr><tr><td>...</td><td></td><td>yellowstone_valley_brewing</td><td>United States</td><td>null</td></tr><tr><td>...</td><td></td><td>yuengling_son_brewing</td><td>United States</td><td>null</td></tr><tr><td>...</td><td></td><td>zea_rotisserie_and_brewery</td><td>United States</td><td>null</td></tr><tr><td>...</td><td></td><td>fosters_tien_gang</td><td>Viet Nam</td><td>null</td></tr><tr><td>...</td><td></td><td>hue_brewery</td><td>Viet Nam</td><td>null</td></tr></tbody></table><p>So as you can see in the examples above, the query uses the startkey, a document id, and just passes it using skip=1.</p><p>Let&#x27;s now look at the application code, once again in Python</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly python"><pre tabindex="0" class="prism-code language-python codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> couchbase </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Couchbase</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Couchbase</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucket</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;beer-sample&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hasRow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">rowPerPage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">currentStartkey</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">startDocId</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> hasRow </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    hasRow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    skip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> page </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-- Page %s --&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    rows </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;by_country&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> limit</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">rowPerPage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">skip</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> startkey</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">currentStartkey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> startkey_docid</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">startDocId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> row </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> rows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        hasRow </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Country: \&quot;%s\&quot; \t Id: &#x27;%s&#x27;&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">docid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        currentStartkey </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        startDocId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> row</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">docid</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot; -- -- -- -- \n&quot;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This application loops on all the pages until the end of the index</p><p>Using this approach, the application start to read the index at a specific key (<code>startkey</code> parameter), and only loop on the necessary entry in the index. This is more efficient than using the simple skip approach.  </p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="views-with-reduce-function"></a>Views with Reduce function<a class="hash-link" href="#views-with-reduce-function" title="Direct link to heading">#</a></h4><p>When your view is using a reduce function, if you want to paginate on the various keys only (with the reduce function) you need to use the <code>skip</code> and <code>limit</code> parameters.</p><p>When you are using the  paramater <code>startkey_docid</code> with a reduce function it will calculate the reduce only to the subset of document ids that are part of your query.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="couchbase-java-sdk-paginator"></a>Couchbase Java SDK Paginator<a class="hash-link" href="#couchbase-java-sdk-paginator" title="Direct link to heading">#</a></h3><p>In the previous examples, I have showed how to do pagination using the various query parameters. The Java SDK provides a Paginator object to help developers to deal with pagination. The following example is using the same view with the Paginator API.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">package com.couchbase.devday;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.couchbase.client.CouchbaseClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.couchbase.client.protocol.views.*;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.net.URI;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.HashMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.LinkedList;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Properties;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.logging.ConsoleHandler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.logging.Handler;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.logging.Level;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.logging.Logger;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JavaPaginatorSample {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static void main(String[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    configure();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;--------------------------------------------------------------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;\tCouchbase - Paginator&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(&quot;--------------------------------------------------------------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;URI&gt; uris = new LinkedList&lt;URI&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    uris.add(URI.create(&quot;http://127.0.0.1:8091/pools&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    CouchbaseClient cb = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cb = new CouchbaseClient(uris, &quot;beer-sample&quot;, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;--------------------------------------------------------------------------&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Breweries (by_name) with docs &amp; JSON parsing&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        View view = cb.getView(&quot;test&quot;, &quot;by_country&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Query query = new Query();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int docsPerPage = 5;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Paginator paginatedQuery = cb.paginatedQuery(view, query, docsPerPage);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int pageCount = 0;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        while(paginatedQuery.hasNext()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            pageCount++;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot; -- Page &quot;+ pageCount +&quot; -- &quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ViewResponse response = paginatedQuery.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ViewRow row : response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.println(row.getKey() + &quot; : &quot; + row.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot; -- -- -- &quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;\n\n&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cb.shutdown(10, TimeUnit.SECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.err.println(&quot;Error connecting to Couchbase: &quot; + e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private static void configure() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(Handler h : Logger.getLogger(&quot;com.couchbase.client&quot;).getParent().getHandlers()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(h instanceof ConsoleHandler) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            h.setLevel(Level.OFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Properties systemProperties = System.getProperties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    systemProperties.put(&quot;net.spy.log.LoggerImpl&quot;, &quot;net.spy.memcached.compat.log.SunLogger&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.setProperties(systemProperties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Logger logger = Logger.getLogger(&quot;com.couchbase.client&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger.setLevel(Level.OFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for(Handler h : logger.getParent().getHandlers()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(h instanceof ConsoleHandler){</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            h.setLevel(Level.OFF);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So as you can see you can easily paginate on the results of a Query using the Java Paginator.</p><ul><li>At the line #37, the Paginator is created from using the view and query objects and a page size is specified</li><li>Then you just need to use the hasNext() and next() methods to navigate in the results.</li></ul><p>The Java Paginator  is aware of the fact that they query is using a reduce or not, so you can use it with all type of queries - Internally it will switch between the skip/limit approach and the doc_id approaches. You can <a href="https://github.com/couchbase/couchbase-java-client/blob/1.1.9/src/main/java/com/couchbase/client/protocol/views/Paginator.java#L176-L195" target="_blank" rel="noopener noreferrer">see how it is done in the Paginator class</a>.</p><p>Note that if you want to do that in a Web application between HTTP request you must keep the Paginator object in the user session since the current API keeps the current page in its state.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>In this blog post you have  learned how to deal with pagination in Couchbase views; to summarize</p><ul><li>The pagination is based on some specific parameters that you send when executing a query.</li><li>Java developers can use the <a href="http://www.couchbase.com/autodocs/couchbase-java-client-1.2.0/com/couchbase/client/protocol/views/Paginator.html" target="_blank" rel="noopener noreferrer">Paginator</a> class that simplifies pagination.</li></ul><p>I am inviting you to look at the new Couchbase Query Language N1QL, still under development, that will provide more options to developers including pagination, using LIMIT &amp; OFFSET parameters, for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sql"><pre tabindex="0" class="prism-code language-sql codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> fname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> age</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> tutorial</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> age </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">OFFSET</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If you want to learn more about N1QL:</p><ul><li><a href="http://query.couchbase.com/" target="_blank" rel="noopener noreferrer">N1QL on Couchbase Community Portal</a></li><li><a href="http://query.pub.couchbase.com/tutorial/" target="_blank" rel="noopener noreferrer">N1QL Online Tutorial</a></li></ul></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase">How to implement Document Versioning with Couchbase</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-07-18T00:00:00.000Z" itemprop="datePublished">July 18, 2013</time> · 7 min read</div></header><div class="markdown" itemprop="articleBody"><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>Developers are often asking me how to &quot;version&quot; documents with Couchbase 2.0. The short answer is: the clients and server do not expose such feature, but it is quite easy to implement.</p><p>In this article I will use a basic approach, and you will be able to extend it depending of your business requirements.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--3 text--right"><a aria-label="Read more about How to implement Document Versioning with Couchbase" href="/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/07/11/deploy-your-node-slash-couchbase-application-to-the-cloud-with-clever-cloud">Deploy your Node/Couchbase application to the cloud with Clever Cloud</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-07-11T00:00:00.000Z" itemprop="datePublished">July 11, 2013</time> · 6 min read</div></header><div class="markdown" itemprop="articleBody"><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p><a href="http://www.clever-cloud.com/en/" target="_blank" rel="noopener noreferrer">Clever Cloud</a> is the first PaaS to provide Couchbase as a service allowing developers to run applications in a fully managed environment. This article shows how to deploy an existing application to Clever Cloud.</p><p><img src="http://f.cl.ly/items/2L2M2k2O000e3g2N1z3z/couchbase_gradient_clever.png"></p><p>I am using a very simple Node application that I have documented in a previous article: “<a href="http://tugdualgrall.blogspot.fr/2013/03/easy-application-development-with.html" target="_blank" rel="noopener noreferrer">Easy application development with Couchbase, Angular and Node</a>”.</p><p>Clever Cloud provides support for various databases MySQL, PostgreSQL, but also and this is most important for me <a href="http://www.clever-cloud.com/en/services/couchbase.html" target="_blank" rel="noopener noreferrer">Couchbase</a>. No only Clever Cloud allows you to use database services but also you can deploy and host your application that could be developed in the language/technology of your choice : Java, Node, Scala, Python, PHP, … and all this in a secure, scalable and managed environment.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--3 text--right"><a aria-label="Read more about Deploy your Node/Couchbase application to the cloud with Clever Cloud" href="/blog/2013/07/11/deploy-your-node-slash-couchbase-application-to-the-cloud-with-clever-cloud"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/07/03/sql-to-nosql-copy-your-data-from-mysql-to-couchbase">SQL to NoSQL : Copy your data from MySQL to Couchbase</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-07-03T00:00:00.000Z" itemprop="datePublished">July 3, 2013</time> · 6 min read</div></header><div class="markdown" itemprop="articleBody"><p><strong>TL;DR:</strong> Look at the <a href="https://github.com/tgrall/couchbase-sql-importer" target="_blank" rel="noopener noreferrer">project on Github</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>During my last interactions with the Couchbase community, I had the question how can I easily import my data from my current database into Couchbase. And my answer was always the same:</p><ul><li>Take an ETL such as Talend to do it</li><li>Just write a small program to copy the data from your RDBMS to Couchbase...</li></ul><p>So I have written this small program that allows you to import the content of a RDBMS into Couchbase. This tools could be used as it is, or you can look at the code to adapt it to your application.</p><iframe width="675" height="380" src="https://www.youtube.com/embed/xzqBjhYKCLY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="the-tool-couchbase-sql-importer"></a>The Tool: Couchbase SQL Importer<a class="hash-link" href="#the-tool-couchbase-sql-importer" title="Direct link to heading">#</a></h3><p>The Couchbase SQL Importer, available <a href="http://github.com/tgrall/couchbase-sql-importer" target="_blank" rel="noopener noreferrer">here</a>, allows you with a simple command line to copy all -or part of- your SQL schema into Couchbase. Before explaining how to run this command, let&#x27;s see how the data are stored into Couchbase when they are imported:</p><ul><li>Each table row is imported a single JSON document<ul><li>where each table column becomes a JSON attribute</li></ul></li><li>Each document as a key made of the name of the table and a counter (increment)</li></ul><p>The following concrete example, based on the <a href="http://dev.mysql.com/doc/world-setup/en/index.html" target="_blank" rel="noopener noreferrer">MySQL World sample database</a>, will help you to understand how it works. This database contains 3 tables : City, Country, CountryLanguage. The City table looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+------+-----+---------+----------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Field       | Type     | Null | Key | Default | Extra          |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+------+-----+---------+----------------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| ID          | int(11)  | NO   | PRI | NULL    | auto_increment |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Name        | char(35) | NO   |     |         |                |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| CountryCode | char(3)  | NO   |     |         |                |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| District    | char(20) | NO   |     |         |                |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Population  | int(11)  | NO   |     | 0       |                |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+----------+------+-----+---------+----------------+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The JSON document that matches this table looks like the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">city</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3805</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;Name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;San Francisco&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;District&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;California&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ID&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3805</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;Population&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">776733</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;CountryCode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;USA&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You see that here I am simply taking all the rows and &quot;moving&quot; them into Couchbase. This is a good first step to play with your dataset into Couchbase, but it is probably not the final model you want to use for your application; most of the time you will have to see when to use embedded documents, list of values, .. into your JSON documents.</p><p>In addition to the JSON document the tool create views based on the following logic:</p><ul><li>a view that list all imported documents with the name of the &quot;table&quot; (aka type) as key</li><li>a view for each table with the primary key columns</li></ul><p>View: all/by_type</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4079</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;country&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">239</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">984</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see this view allows you to get with a single Couchbase query the number of document by type.</p><p>Also for each table/document type, a view is created where the key of the index is built from the table primary key. Let&#x27;s for example query the &quot;City&quot; documents.</p><p>View: city/by_pk?reduce=false&amp;limit=5</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;total_rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4079</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city:1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city:2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city:3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city:4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;city:5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The index key matches the value of the <code>City.ID</code> column.  When the primary key is made of multiple columns the key looks like:</p><p>View: CountryLanguage/by_pk?reduce=false&amp;limit=5</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;total_rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">984</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;rows&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage:1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ABW&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Dutch&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage:2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ABW&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;English&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage:3&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ABW&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Papiamento&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage:4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;ABW&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Spanish&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;countrylanguage:5&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;key&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;AFG&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Balochi&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;value&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token null keyword" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This view is built from the CountryLanguage table primary key made of <code>CountryLanguage.CountryCode and  </code>CountryLanguage.Language` columns.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+------+-----+---------+-------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Field       | Type          | Null | Key | Default | Extra |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+------+-----+---------+-------+</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| CountryCode | char(3)       | NO   | PRI |         |       |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Language    | char(30)      | NO   | PRI |         |       |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| IsOfficial  | enum(&#x27;T&#x27;,&#x27;F&#x27;) | NO   |     | F       |       |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">| Percentage  | float(4,1)    | NO   |     | 0.0     |       |</span></span><span class="token-line" style="color:#393A34"><span class="token plain">+-------------+---------------+------+-----+---------+-------+</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>How to use Couchbase SQL Importer tool? </strong></p><p>The importer is a simple Java based command line utility, quite simple to use:</p><p>1- Download the <a href="http://goo.gl/IF89e" target="_blank" rel="noopener noreferrer">CouchbaseSqlImporter.jar file from here</a>. This file is contains all the dependencies to work with Couchbase: the Java Couchbase Client, and GSON.
2- Download the JDBC driver for the database you are using as data source. For this example I am using MySQL and I have download the driver for MySQL Site.
3- Configure the import using a properties file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">## SQL Information ##</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sql.connection=jdbc:mysql://192.168.99.19:3306/world</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sql.username=root</span></span><span class="token-line" style="color:#393A34"><span class="token plain">sql.password=password</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## Couchbase Information ##</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cb.uris=http://localhost:8091/pools</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cb.bucket=default</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cb.password=</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">## Import information</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import.tables=ALL</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import.createViews=true</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import.typefield=type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import.fieldcase=lower</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This sample properties file contains three sections :</p><ul><li>The two first sections are used to configure the connections to your SQL database and Couchbase cluster (note that the bucket must be created first)</li><li>The third section allow you to configure the import itself</li></ul><p>4- Run the tool !</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">java -cp &quot;./CouchbaseSqlImporter.jar:./mysql-connector-java-5.1.25-bin.jar&quot; com.couchbase.util.SqlImporter import.properties</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>So you run the Java command with the proper classpath (-cp parameter).</p><p>And you are done, you can get your data from your SQL database into Couchbase.</p><p>If you are interested to see how it is working internally, you can take a look to the next paragraph.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="the-code-how-it-works"></a>The Code: How it works?<a class="hash-link" href="#the-code-how-it-works" title="Direct link to heading">#</a></h3><p>The main class of the tool is really simple  <a href="https://github.com/tgrall/couchbase-sql-importer/blob/master/sql-importer-lib/src/main/java/com/couchbase/util/SqlImporter.java" target="_blank" rel="noopener noreferrer">com.couchbase.util.SqlImporter</a>, the process is:</p><ol><li>Connect to the SQL database</li><li>Connect to Couchbase</li><li>Get the list of tables</li><li>For each tables execute a &quot;select * from table&quot;
4.1. Analyze the ResultSetMetadata to get the list of columns
4.2. Create a Java map for each rows where the key is the name of the columns and the value…is the value
4.3. Serialize this Map into a GSON document and save it into Couchbase</li></ol><p>The code is available in the <a href="https://github.com/tgrall/couchbase-sql-importer/blob/master/sql-importer-lib/src/main/java/com/couchbase/util/SqlImporter.java#L212" target="_blank" rel="noopener noreferrer">ImportTable(String table)</a> Java method.</p><p>One interesting point is that you can use and extend the code to deal with your application.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>I have created this tool quickly to help some people in the community, if you are using it and need new features, let me know, using comment or pull request.</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/05/31/create-a-couchbase-cluster-in-less-than-a-minute-with-ansible">Create a Couchbase cluster in less than a minute with Ansible</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-05-31T00:00:00.000Z" itemprop="datePublished">May 31, 2013</time> · 6 min read</div></header><div class="markdown" itemprop="articleBody"><p><strong>TL;DR:</strong> Look at the Couchbase Ansible Playbook on my <a href="https://github.com/tgrall/couchbase-ansible-playbook" target="_blank" rel="noopener noreferrer">Github</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>When I was looking for a more effective way to create my cluster I asked some sysadmins which tools I should use to do it. The answer I got during <a href="http://www.netways.de/osdc" target="_blank" rel="noopener noreferrer">OSDC</a> was not <a href="https://puppetlabs.com/" target="_blank" rel="noopener noreferrer">Puppet</a>, nor <a href="http://www.opscode.com/chef/" target="_blank" rel="noopener noreferrer">Chef</a>, but was <a href="http://ansible.cc/" target="_blank" rel="noopener noreferrer">Ansible</a>.</p><p>This article shows you how you can easily configure and create a Couchbase cluster deployed and many linux boxes...and the only thing you need on these boxes is an SSH Server!</p><p>Thanks to <a href="http://jpmens.net/" target="_blank" rel="noopener noreferrer">Jan-Piet Mens</a> that was one of the person that convinced me to use Ansible and answered questions I had about Ansible.</p><p>You can watch the demonstration below, and/or look at all the details in the next paragraph.</p><iframe width="675" height="380" src="https://www.youtube.com/embed/COb6y89xcYY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="ansible"></a>Ansible<a class="hash-link" href="#ansible" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ansible-is-an-open-source-software-that-allows-administrator-to-configure-and-manage-many-computers-over-ssh"></a>Ansible is an open-source software that allows administrator to configure and manage many computers over SSH.<a class="hash-link" href="#ansible-is-an-open-source-software-that-allows-administrator-to-configure-and-manage-many-computers-over-ssh" title="Direct link to heading">#</a></h4><p>I won&#x27;t go in all the details about the installation, just follow the steps documented in the <a href="http://ansible.cc/docs/gettingstarted.html" target="_blank" rel="noopener noreferrer">Getting Started Guide</a>. As you can see from this guide, you just need Python and few other libraries and clone Ansible project from Github. So I am expecting that you have Ansible working with your various servers on which you want to deploy Couchbase.</p><p>Also for this first scripts I am using <strong>root</strong> on my server to do all the operations. So be sure you have register the root ssh keys to your administration server, from where you are running the Ansible scripts.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-a-couchbase-cluster"></a>Create a Couchbase Cluster<a class="hash-link" href="#create-a-couchbase-cluster" title="Direct link to heading">#</a></h3><p>So before going into the details of the Ansible script it is interesting to explain how you create a Couchbase Cluster. So here are the 5 steps to create and configure a cluster:</p><ol><li>Install Couchbase on each nodes of the cluster, as documented <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-getting-started-install-ubuntu.html" target="_blank" rel="noopener noreferrer">here</a>.</li><li>Take one of the node and &quot;initialize&quot; the cluster,  using <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-cli-other-examples.html" target="_blank" rel="noopener noreferrer">cluster-init command</a>.</li><li>Add the other nodes to the cluster, using <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-cli-other-examples.html" target="_blank" rel="noopener noreferrer">server-add command</a>.</li><li>Rebalance, using <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-cli-other-examples.html" target="_blank" rel="noopener noreferrer">rebalance command</a>.</li><li>Create a Bucket, using <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-cli-other-examples.html" target="_blank" rel="noopener noreferrer">bucket-create command</a>.</li></ol><p>So the goal now is to create an Ansible Playbook that does these steps for you.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="ansible-playbook-for-couchbase"></a>Ansible Playbook for Couchbase<a class="hash-link" href="#ansible-playbook-for-couchbase" title="Direct link to heading">#</a></h4><p>The first think you need is to have the list of hosts you want to target, so I have create a <a href="https://github.com/tgrall/couchbase-ansible-playbook/blob/master/hosts" target="_blank" rel="noopener noreferrer">hosts file</a> that contains all my server organized in 2 groups:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">[couchbase-main]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">vm1.grallandco.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">[couchbase-nodes]</span></span><span class="token-line" style="color:#393A34"><span class="token plain">vm2.grallandco.com</span></span><span class="token-line" style="color:#393A34"><span class="token plain">vm3.grallandco.com</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The group [couchbase-main] group is just one of the node that will drive the installation and configuration, as you probably already know, Couchbase does not have any master... All nodes in the cluster are identical.</p><p>To ease the configuration of the cluster, I have create another file that contains all parameters that must be sent to all the various commands. This file is located in the <a href="https://github.com/tgrall/couchbase-ansible-playbook/blob/master/group_vars/all" target="_blank" rel="noopener noreferrer">group_vars/all</a> see the section <a href="http://ansible.cc/docs/patterns.html#splitting-out-host-and-group-specific-data" target="_blank" rel="noopener noreferrer">Splitting Out Host and Group Specific Data</a> in the documentation.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain"># Adminisrator user and password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_user: Administrator</span></span><span class="token-line" style="color:#393A34"><span class="token plain">admin_password: password</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># ram quota for the cluster</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cluster_ram_quota: 1024</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"># bucket and replicas</span></span><span class="token-line" style="color:#393A34"><span class="token plain">bucket_name: ansible</span></span><span class="token-line" style="color:#393A34"><span class="token plain">bucket_ram_quota: 512</span></span><span class="token-line" style="color:#393A34"><span class="token plain">num_replicas: 2</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Use this file to configure your cluster.</p><p>Let&#x27;s describe the <a href="https://github.com/tgrall/couchbase-ansible-playbook/blob/master/couchbase.yml" target="_blank" rel="noopener noreferrer">playbook file</a> :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">- name: Couchbase Installation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hosts: all</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user: root</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tasks:</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: download Couchbase package</span></span><span class="token-line" style="color:#393A34"><span class="token plain">get_url: url=http://packages.couchbase.com/releases/2.0.1/couchbase-server-enterprise_x86_64_2.0.1.deb dest=~/.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Install dependencies</span></span><span class="token-line" style="color:#393A34"><span class="token plain">apt: pkg=libssl0.9.8 state=present</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Install Couchbase .deb file on all machines</span></span><span class="token-line" style="color:#393A34"><span class="token plain">shell: dpkg -i ~/couchbase-server-enterprise_x86_64_2.0.1.deb</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As expected, the installation has to be done on <strong>all</strong> servers as <strong>root</strong> then we need to execute 3 tasks:</p><ol><li>Download the product, the get_url command will only download the file if not already present</li><li>Install the dependencies with the apt command, the state=present allows the system to only install this package if not already present</li><li>Install Couchbase with a simple shell command. (here I am not checking if Couchbase is already installed)</li></ol><p>So we have now installed Couchbase on all the nodes. Let&#x27;s now configure the first node and add the others:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">- name: Initialize the cluster and add the nodes to the cluster</span></span><span class="token-line" style="color:#393A34"><span class="token plain">hosts: couchbase-main</span></span><span class="token-line" style="color:#393A34"><span class="token plain">user: root</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">tasks:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Configure main node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">shell: /opt/couchbase/bin/couchbase-cli cluster-init -c 127.0.0.1:8091  --cluster-init-username=${admin_user} --cluster-init-password=${admin_password} --cluster-init-port=8091 --cluster-init-ramsize=${cluster_ram_quota}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Create shell script for configuring main node</span></span><span class="token-line" style="color:#393A34"><span class="token plain">action: template src=couchbase-add-node.j2 dest=/tmp/addnodes.sh mode=750</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Launch config script</span></span><span class="token-line" style="color:#393A34"><span class="token plain">action: shell /tmp/addnodes.sh</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: Rebalance the cluster</span></span><span class="token-line" style="color:#393A34"><span class="token plain">shell: /opt/couchbase/bin/couchbase-cli rebalance -c 127.0.0.1:8091 -u ${admin_user} -p ${admin_password}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">- name: create bucket ${bucket_name} with ${num_replicas} replicas</span></span><span class="token-line" style="color:#393A34"><span class="token plain">shell: /opt/couchbase/bin/couchbase-cli bucket-create -c 127.0.0.1:8091 --bucket=${bucket_name} --bucket-type=couchbase --bucket-port=11211 --bucket-ramsize=${bucket_ram_quota}  --bucket-replica=${num_replicas} -u ${admin_user} -p ${admin_password}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now we need to execute specific taks on the &quot;main&quot; server:</p><ul><li>Initialization of the cluster using the Couchbase CLI, on line 06 and 07</li></ul><p>Then the system needs to ask all other server to join the cluster. For this the system needs to get the various IP and for each IP address execute the add-server command with the IP address. As far as I know it is not possible to get the IP address from the main playbook YAML file, so I ask the system to generate a shell script to add each node and execute the script.</p><p>This is done from the line 09 to 13.</p><p>To generate the shell script, I use <a href="http://ansible.cc/docs/modules.html#template" target="_blank" rel="noopener noreferrer">Ansible Template</a>, the template is available in the <a href="https://github.com/tgrall/couchbase-ansible-playbook/blob/master/couchbase-add-node.j2" target="_blank" rel="noopener noreferrer">couchbase-add-node.j2</a> file.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly sh"><pre tabindex="0" class="prism-code language-sh codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{% for host in groups[&#x27;couchbase-nodes&#x27;] %}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/couchbase/bin/couchbase-cli server-add -c 127.0.0.1:8091 -u ${admin_user} -p ${admin_password} --server-add={{ hostvars[host][&#x27;ansible_eth0&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;] }}:8091 --server-add-username=${admin_user} --server-add-password=${admin_password}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{% endfor %}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As you can see this script loop on each server in the [couchbase-nodes] group and use its IP address to add the node to the cluster.</p><p>Finally the script rebalance the cluster (line 16) and add a new bucket (line 19).</p><p>You are now ready to execute the playbook using the following command :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./bin/ansible-playbook -i ./couchbase/hosts ./couchbase/couchbase.yml -vv</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I am adding the -vv parameter to allow you to see more information about what&#x27;s happening during the execution of the script.</p><p>This will execute all the commands described in the playbook, and after few seconds you will have a new cluster ready to be used! You can for example open a browser and go to the Couchase Administration Console and check that your cluster is configured as expected.</p><p> <img src="http://1.bp.blogspot.com/-L-3yeJZECwY/Uaj_PA_aVUI/AAAAAAAAAcg/fKBZ47Nhd4M/s320/Screen+Shot+2013-05-31+at+9.50.44+PM.png"></p><p>As you can see it is really easy and fast to create a new cluster using Ansible.</p><p>I have also create a script to uninstall properly the cluster.. just launch</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">./bin/ansible-playbook -i ./couchbase/hosts ./couchbase/couchbase-uninstall.yml</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/05/28/six-months-as-technical-evangelist-at-couchbase">Six months as Technical Evangelist at Couchbase</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-05-28T00:00:00.000Z" itemprop="datePublished">May 28, 2013</time> · 6 min read</div></header><div class="markdown" itemprop="articleBody"><p>Already 6 months! Already 6 months that I have joined Couchbase as Technical Evangelist. This is a good opportunity to take some time to look back.</p><p>So first of all what is a Developer/Technical Evangelist?</p><p>Hmm it depends of each company/product, but let me tell you what it is for me, inside Couchbase. This is one of the most exciting job I ever had. And I think it is the best job you can have when you are passionate about technology, and you like to share this passion with others. So my role as Technical Evangelist is to help the developers to adopt NoSQL technologies in general, and as you can guess Couchbase in particular.</p><p>Let&#x27;s now see in more details what I have done during these past six months and why I am so happy about it. I have organized the different activities in three types:</p><ul><li>Outbound activities : meet the developers</li><li>Online activities : reach even more developers</li><li>Inbound Activities : make the product better !</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="outbound-activities--meet-the-developers-"></a>Outbound activities : meet the developers !<a class="hash-link" href="#outbound-activities--meet-the-developers-" title="Direct link to heading">#</a></h3><p>A large part of my activities for this first semester was made of conferences and meetups. All these events are great opportunities for me to talk about NoSQL and get more people to use Couchbase Server 2.0, here a short list of what I have done:</p><ul><li>participated to many Couchbase Developer Days in various cities (Portland, Seattle, Vancouver, Oslo, Copenhagen, Stockholm, Munich, Amsterdam, Barcelona, Paris, ...), these are one day workshops where I am helping developers to get their hands dirty on Couchbase</li><li>participated to Couchconf Berlin and Couchbase [UK] our main European events where I met many Customer and key members of the community</li><li>submitted talks to conferences and adapt them to the conference, then spoken in various conferences about NoSQL and Couchbase (<a href="http://33degree.org/" target="_blank" rel="noopener noreferrer">33Degree Warsaw,</a>  <a href="http://www.johnbryce.co.il/events/nosql-big-data" target="_blank" rel="noopener noreferrer">NoSQL &amp; Big Data Israel</a>, <a href="http://devoxx.fr/" target="_blank" rel="noopener noreferrer">Devoxx France</a>, <a href="http://nosql-matters.org/" target="_blank" rel="noopener noreferrer">NoSQL Matters</a>, and many others).</li><li>met many developers during user groups and meetups. I have to say that I have been very active there, and quite happy to see that NoSQL is a very hot topic for developers, and this in all languages.</li><li>delivered <a href="http://en.wikipedia.org/wiki/Brown_bag_seminar" target="_blank" rel="noopener noreferrer">BrowBagLunch</a>es to various technical teams in companies.</li></ul><p>Yes! Be a Technical Evangelist means, at least for me, be on the road. It is very nice to meet developers from various countries, different cultures, languages, and… this also means tasting many different types of food!</p><p>Another interesting thing when you work on a database/infrastructure layer is the fact that it is <em>technology agnostic</em>; you can access Couchbase with multiple programming languages: Java, .Net,Javascript/Node, Ruby, PHP, Python, C, … and even Go. So with this job I met developers with different backgrounds and views about application development. So yes when I am at a conference or meetup, I am suppose to &quot;teach&quot; something to people, but I have also learned a lot of things, and still doing it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="online-activities--reach-even-more-developers"></a>Online activities : reach even more developers!<a class="hash-link" href="#online-activities--reach-even-more-developers" title="Direct link to heading">#</a></h3><p>Meeting developers during conferences is great but it, it is also very important to produce content to reach even more people, so I have :</p><ul><li>written blog post about Couchbase usage, most of them based on feedback/questions from the community</li><li>created sample code to show how it works</li><li>monitored and answered questions on various sites and mailing lists, from Couchbase discussion forums, mailing lists, Stack Overflow, Quora and others...</li></ul><p>This task is quite interesting because it is the moment where you can reach many developers and also get feedback from users, and understand how they are using the product. I have to say that I was not as productive as I was expected, mainly because I was traveling a lot during this period.</p><p>Another important thing about online activities, is the &quot;Couchbase Community&quot; itself, many users of Couchbase are creating content : blog posts, samples, new applications, or features - for example I am talking with a person that is developing a <a href="http://blog.rikulo.org/posts/2013/May/General/couchclient/" target="_blank" rel="noopener noreferrer">Dart Client for Couchbase</a>, so as Technical Evangelist I am also working closely with the most active contributor.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="inbound-activities--make-the-product-better-"></a>Inbound Activities : make the product better !<a class="hash-link" href="#inbound-activities--make-the-product-better-" title="Direct link to heading">#</a></h3><p>So the ultimate goal of a Technical Evangelist at Couchbase is to &quot;convert&quot; developers to NoSQL/Couchbase and get them to talk about Couchbase. Meeting them online or during events is a way of achieving this; but it is also great to do it directly <em>with</em> the product. This means participating to the &quot;development&quot; of the product or its ecosystem. Here some of the things that I have done on this topic:</p><ul><li>talked a lot with the development team, core developers, product managers, architects, … Quite exciting to work with so much smart people and have access to them. During this discussions I was able to comment the roadmap, influence features, but also it is all the time an opportunity to learn new things about Couchbase - and many other things around architecture, programming languages, take a look for example to <a href="http://damienkatz.net/2013/01/the_unreasonable_effectiveness_of_c.html" target="_blank" rel="noopener noreferrer">this nice post from Damien Katz</a> .</li><li>contributed some code, yes remember Couchbase is an open source project and it is quite easy to participate to the development. Obviously based on my skills I have only help a little bit with the Java and the Javascript SDK. So if like me you are interested to contribute to the project, take a look to this page: &quot;<a href="http://www.couchbase.com/wiki/display/couchbase/Contributing+Changes" target="_blank" rel="noopener noreferrer">Contributing Changes</a>&quot;</li><li>but the biggest contributions to the products are such like doc reviews, testing and writing bug reports, and this is very important and interesting, since once again it helps a lot with the product adoption by the developers.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="so-what"></a>So what?<a class="hash-link" href="#so-what" title="Direct link to heading">#</a></h3><p>As you can see the Technical Evangelist job is a quite exciting job, and one of the reason I really love it, it is simply because it allows me to do many different things, that are all related to the technology. Six months is still a very short period, I still have many things to learn and to with the team to be successful, such as be more present online (blog, sample code, technical article, screencast, ..), be accepted in more conferences, and code a little more (I have to finish for example the Couchbase Data Provider for Hibernate OGM, and many other ideas around application development experience)</p><p>Finally, Couchbase needs you ! This is a good opportunity to say that Couchbase is always looking for talents, especially in the Technical/Developer Evangelist team, so do not hesitate to look at <a href="http://www.couchbase.com/careers" target="_blank" rel="noopener noreferrer">the different job openings</a> and join the team !</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/04/29/screencast-fun-with-couchbase-mapreduce-and-twitter">Screencast : Fun with Couchbase MapReduce and Twitter</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-04-29T00:00:00.000Z" itemprop="datePublished">April 29, 2013</time> · One min read</div></header><div class="markdown" itemprop="articleBody"><p>I have created this simple screencast to show how you can, using Couchbase do some realtime analysis based on Twitter feed.</p><p>The key steps of this demonstration are</p><ol><li>Inject Tweets using a simple program available on my Github <a href="https://github.com/tgrall/couchbase-twitter-injector" target="_blank" rel="noopener noreferrer">Couchbase-Twitter-Injector</a></li><li>Create views to index and query the Tweets by<ul><li>User name</li><li>Tags</li><li>Date</li></ul></li></ol><p>The views that I used in this demonstration are available at the bottom of this post.</p><iframe width="675" height="380" src="https://www.youtube.com/embed/X167R0TV5QE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe><p>Views:</p><iframe width="100%" frameborder="0" id="gist-1df10b10c9dd387995cb"></iframe></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_GeHD" itemprop="headline"><a itemprop="url" href="/blog/2013/03/06/easy-application-development-with-couchbase-angular-and-node">Easy application development with Couchbase, Angular and Node</a></h2><div class="blogPostData_291c margin-vert--md"><time datetime="2013-03-06T00:00:00.000Z" itemprop="datePublished">March 6, 2013</time> · 14 min read</div></header><div class="markdown" itemprop="articleBody"><blockquote><p>Note : This article has been written in March 2013, since Couchbase and its drivers have a changed a lot. I am not working with/for Couchbase anymore, with no time to update the code.</p></blockquote><p>A friend of mine wants to build a simple system to capture ideas, and votes. Even if you can find many online services to do that, I think it is a good opportunity to show how easy it is to develop new application using a Couchbase and Node.js.</p><p>So how to start?</p><p>Some of us will start with the UI, other with the data, in this example I am starting with the model. The basics steps are :</p><ol><li>Model your documents</li><li>Create Views</li><li>Create Services</li><li>Create the UI</li><li>Improve your application by iteration</li></ol><p>The sources of this sample application are available in Gihub :</p><p><a href="https://github.com/tgrall/couchbase-node-ideas" target="_blank" rel="noopener noreferrer">https://github.com/tgrall/couchbase-node-ideas</a></p><p>Use the following command to clone the project locally :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/tgrall/couchbase-node-ideas.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Note:</em> my goal is not to provide a complete application, but to describe the key steps to develop an application.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="model-your-documents"></a>Model your documents<a class="hash-link" href="#model-your-documents" title="Direct link to heading">#</a></h3><p>For this application you need 3 types of document :</p><ul><li>Ideas : describes the idea with a author, title and description</li><li>Vote : the author and a comment - note that it is a choice to not put a value for the vote, in this first version if the vote exists this means user like the idea.</li><li>User : contains all the information about the user (not used in this first version of the application)</li></ul><p>You can argue that it is possible to put the votes as a list of element inside the idea document. In this case I prefer to use different document and reference the idea in the vote since we do not know how many votes/comments will have. Using different documents is also interesting in this case for the following reasons :</p><ul><li>No &quot;concurrent&quot; access, when a user wants to vote he does not change the idea document itself, so no need to put an optimistic locking in place.</li><li>The size of the document will be smaller and easier to cache in memory.</li></ul><p>So documents will look like:</p><iframe width="100%" frameborder="0" id="gist-79f57b13e7a637c7e62e"></iframe><p>What I really like is the fact that I can quickly create a small dataset to validate that it is correct and help me to design the view. The way I do it, I start my server, launch the Couchbase Administration Console, create a bucket, and finally insert document manually and validate the model and views.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-views"></a>Create Views<a class="hash-link" href="#create-views" title="Direct link to heading">#</a></h3><p>Now that I have created some documents, I can think about the way I want to get the information out of the database. For this application I need:</p><ul><li>The list of ideas</li><li>The votes by ideas</li></ul><p>The list of idea for this first version is very simple, we just need to emit the title:</p><iframe width="100%" frameborder="0" id="gist-989a5450811dec8f305e"></iframe><p>For the votes by ideas, I choose to create a collated view, this will give me some interesting options when I will expose them into an API/View layer. I am also for this view using <code>sum()</code> reduce function to be sure I capture the number of votes.</p><iframe width="100%" frameborder="0" id="gist-5fe945cbc12cc59e9dbd"></iframe><p>I have my documents, I have some views that allow me to retrieve the list of ideas, the number of vote by idea and count the vote... So I am ready to expose all these informations to the application using a simple API layer.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-services"></a>Create Services<a class="hash-link" href="#create-services" title="Direct link to heading">#</a></h3><p>Lately I have been playing a lot with Node.js, just because it is nice to learn new stuff and also because it is really easy to use with Couchbase. Think about it Couchbase loves JSON, and Node.js object format is JSON, this means I do not have any marshaling/unmarshaling to do.</p><p>My API layer is quite simple, I just need to create a set of REST endpoint to deal with:</p><ul><li>CRUD operation on each type of document</li><li>List the different Documents</li></ul><p>The code of the services is available in branch <a href="https://github.com/tgrall/couchbase-node-ideas/tree/01-simple-services" target="_blank" rel="noopener noreferrer">01-simple-services</a>:</p><p>You can run the application  with simple services using the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; git checkout -f 01-simple-services</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; node app.js</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and go to you browser using the <a href="http://127.0.0.1:3000" target="_blank" rel="noopener noreferrer">http://127.0.0.1:3000</a></p><p><em>About the project</em></p><p>For this project I am using only 2 node modules <a href="http://expressjs.com/" target="_blank" rel="noopener noreferrer">Express</a> and <a href="https://github.com/couchbase/couchnode" target="_blank" rel="noopener noreferrer">Couchbase</a>. The package.json file looks like :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly json"><pre tabindex="0" class="prism-code language-json codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;couchbase-ideas-management&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;version&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.0.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;private&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;dependencies&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;express&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3.x&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;couchbase&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0.0.11&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>After running the install, let&#x27;s code the new API interface, as said before I am using an iterative approach so for now I am not dealing with the security, I just want to get the basic actions to work.</p><p>I am starting with the endpoints to get and set the documents. I am creating a generic endpoints that take the type as URI parameter allowing user/application to do a get/post on <code>/api/vote</code>, <code>/api/idea</code>. The following code captures this:</p><iframe width="100%" frameborder="0" id="gist-42f0b936a55fd2dcefac"></iframe><p>In each case I start to test if the URI is one of the supported types (idea, vote, user) and if this is the case I call the <code>get()</code> or <code>upsert()</code> method that will do the call to Couchbase.</p><p>The <code>get()</code> and <code>upsert()</code> methods are using more or less the same approach. I test if the document exists, if the type is correct and do the operation to Couchbase. Let&#x27;s focus on the <code>upsert()`` method. I call it </code>upsert()` since the same operation is used to create and update the document.</p><iframe width="100%" frameborder="0" id="gist-91858dcad51affdf3521"></iframe><p>In this function I start by testing if the document contains a type and if the type is the one expected (line 3).</p><p>Then I check if the document id is present, to see if I need to create it or not. This is one of the reason why I like to keep the id/key in the document, yes I duplicate it, but it makes the development really easy. So if I have to create a new document I have to generate a new id. I chose to create a counter for each type. this is why I call the incr function (line 7) and then use the returned value to create the document (line 10).</p><p><em>Note:</em> as you can see, my documents contain the an ID as part of the attributes. This ID is the same value that the one used to set the document (the &quot;key&quot;). It is not necessary a good practice to duplicate this information, and in many case the application only use the document key itself. I personally like to put the ID in the document itself too, because it simplifies a lot the development.</p><p>If the ID is present, I just call the update operation to save the document. (line 15)</p><p>The delete operation is equivalent to the get, using the delete HTTP operation.</p><p>So now I can get, insert and update the documents. I still need to do some work to deal with the lists. As you can guess, here I need to call the views. I won&#x27;t go in the detail of the simple list of ideas. Let&#x27;s focus on the view that shows the result of the votes.</p><iframe width="100%" frameborder="0" id="gist-6468058737ff53553ae1"></iframe><p>For this part of the application I use a small trick to use the collated view. The <code>/api/results/</code> call returns the list of ideas with their title and the total number of votes. The result looks like the following:</p><iframe width="100%" frameborder="0" id="gist-6cfdedf1410ca99744bd"></iframe><p>Note that it is also possible to select only one idea , you just need to pass the id to the call for example.</p><p>If you look in more detail the function, not only I call the view, but I build an array in which I put the idea id, label, then on the next loop, I add the number of vote. This is possible because the view is a collated view of the ideas and its votes.</p><p>I have now my REST Services, including advanced query capabilities. It is time now to use these services and build the user interface.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-the-ui"></a>Create the UI<a class="hash-link" href="#create-the-ui" title="Direct link to heading">#</a></h3><p>For the view I am using AngularJS, that I am packaging in the same node.js application for simplicity reason</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="simple-ui-without-loginsecurity"></a>Simple UI without Login/Security<a class="hash-link" href="#simple-ui-without-loginsecurity" title="Direct link to heading">#</a></h4><p>The code of the application without login is available branch in <a href="https://github.com/tgrall/couchbase-node-ideas/tree/02-simple-ui-no-login" target="_blank" rel="noopener noreferrer">02-simple-ui-no-login</a></p><p>You can run the application  with simple services using the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly shell"><pre tabindex="0" class="prism-code language-shell codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> checkout -f 02-simple-ui-no-login</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> node app.js</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The application is based on AngularJS and Twitter Boostrap.</p><p>I am using basic feature and packaging for Angular :</p><ul><li><code>/public/js/app.js</code> contains the module declaration and all the routes to the different views/controllers</li><li><code>/public/js/controllers.js</code> contains all the controller. I will show some of them but basically this is where that I call the services that I have created above.</li><li><code>/views/partials/</code> contains the different pages/screens used by the application.</li></ul><p>Because the application is quite simple I have not done any packaging of directive, or other functions. This is true at for AngularJS and Node.js parts.</p><p><em>Dummy user management</em></p><p>In this first version of the UI I have not yet integrated any login/security, so I fake the user login using a global scope variable that <code>$scope.user</code> that you can see in the controller <code>AppCtrl()</code>. Since I have not yet implemented the login/security, I have added at the bottom of the page a textfield where you can enter a &quot;dummy&quot; username to test the application. This field is inserted in the <code>/views/index.html</code> page.</p><p><em>List Views and Number of Votes</em></p><p>The home page of the application contains the list of ideas and number of votes.</p><p><img src="http://2.bp.blogspot.com/-tniNkr_Pl0Q/USidTLKHw1I/AAAAAAAAAbQ/BWtfTaAWG1w/s320/ideas-home-page.png"></p><p>Look at the EntriesListCtrl controller and the <code>view/index.html</code> file. As you can guess this is based on the Couchbase collated view that return the list of ideas and number of vote.</p><p><em>Create/Edit an idea</em></p><p>When the user click on the New link in the navigation, the application call the view <code>/view/partials/idea-form.html</code>.  This form is called using the &quot;/#/idea/new&quot; URL.</p><p>Just look at the <code>IdeaFormCtrl</code> controller to see what is happening :</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">IdeaFormCtrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">$rootScope</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $scope</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $routeParams</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $http</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> $location</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">idea</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">$routeParams</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">$http</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> url</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;/api/idea/&#x27;</span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> $routeParams</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">id</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">success</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> status</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> headers</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">           </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">idea</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">save</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">          </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">idea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;idea&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// set the type</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">idea</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">user_id</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">user</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        $http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/api/idea&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">$scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">idea</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">success</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            $</span><span class="token dom variable" style="color:#36acaa">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    $scope</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">cancel</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        $</span><span class="token dom variable" style="color:#36acaa">location</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;/&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">IdeaFormCtrl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">$inject</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;$rootScope&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$scope&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$routeParams&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token string" style="color:#e3116c">&#x27;$http&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;$location&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>First of all I test if the controller is called with a idea identifier in the URL ( <code>$routeParams.id</code> - line 3) . If the ID is present, I call the REST API to get the idea and set it into the <code>$scope.idea</code> variable.</p><p>Then on line 9, you can see the <code>$scope.save()</code> function that calls the REST API to save/update the idea to Couchbase. I use the line 10 and 11 to set the user and the type of data to the idea.</p><p><em>Note:</em> It is interesting to look at these lines, by adding the two attributes (user &amp; type) I modify the &quot;schema&quot; of my data. I am adding new fields to my document that will be stored as it is in Couchbase. Once again, you see here that I drive the data type from my application. I could take another approach and force the type in the service layer. For this example I chose to put that in the application layer, that is supposed to send the proper data types.</p><p><em>Other Interactions</em></p><p>The same approach is used to create a vote associated to a user/idea as you can see in the <code>VoteFormCtrl</code>  controller.</p><p>I won&#x27;t go in all the details of all operations, I am just inviting you to look at the code of the application, and feel free to add comment to this blog post if I need to clarify other part of the application.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="iterative-development--adding-a-value-to-the-vote"></a>Iterative Development : adding a value to the vote!<a class="hash-link" href="#iterative-development--adding-a-value-to-the-vote" title="Direct link to heading">#</a></h4><p>The code of the services is available in branch 01-simple-services:</p><p>You can run the application with simple services using the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">&gt; git checkout -f 03-vote-with-value</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; node app.js</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Adding the field in the form</em></p><p>Something that I really like about working with AngularJS, Node and Couchbase is the fact that the developer uses JSON from the database to the browser.</p><p>So let&#x27;s implement a new feature, where instead of having only a comment the user can give a rate to its vote from 1 to 5. Doing that is quite easy, here are the steps:</p><ul><li>Modify the UI : adding a new field</li><li>Modify the Couchabe View to use the new field</li></ul><p>This is it! AngularJS deals with the binding of the new field, so I just need to edit the <code>/views/partials/idea-form.html</code> to add this. For this I need to add the list of values in the controller and expose it into a select box in form.</p><p>The list of value located in the <code>$scope.ratings</code> variable :</p><iframe width="100%" frameborder="0" id="gist-fe7c8625a6f54dfd2425"></iframe><p>Once this is done you can add a select box into your view using the following code :</p><iframe width="100%" frameborder="0" id="gist-d4115c3dbdd5a25614d9"></iframe><p>To add the select box into the form, I just use AngularJS features:</p><ul><li>the list of value described in my controller using the <code>ng-options</code> attribute</li><li>the binding to the vote.rating field object using <code>ng-model</code> attribute.</li></ul><p>I am adding the field in my form, I bind this field to my Javascript object; and... nothing else! Since my REST API is just consuming the JSON object as it is, AngularJS will send the vote object with the new attribute.</p><p><em>Update the view to use the rating</em></p><p>Now that my database is dealing with a new attribute in the vote, I need to update my view to use this in the sum function. (I could calculate an average too, but here I want the sum of all the vote/ratings).</p><iframe width="100%" frameborder="0" id="gist-c2fb3f9a3127df75e454"></iframe><p>The only line that I have changed is the line number 7. The logic is simple, if the rating is present I emit it, if not I emit a 2, that is a medium rating for an idea.</p><p>This is a small tip that allow me to have a working view/system without having to update all the existing document if I have some.</p><p>I&#x27;ll stop here for now, and will add new feature later such as User Authentication and User Management using for example <a href="http://passportjs.org/" target="_blank" rel="noopener noreferrer">Passport</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="version-and-upgrade-management"></a>Version and Upgrade Management<a class="hash-link" href="#version-and-upgrade-management" title="Direct link to heading">#</a></h3><p>If you looked closely to the code of the application the views are automatically imported from the app.js file when the application is starting.</p><p>In fact I have added a small function that check the current version installed and update the views with the correct version when needed.</p><p>You can look at the function <a href="https://github.com/tgrall/couchbase-node-ideas/blob/03-vote-with-value/app.js#L21" target="_blank" rel="noopener noreferrer"><code>initApplication()</code></a> :</p><ul><li>Load the version number from Couchbase (document with ID &quot;<code>app.version</code>&quot;)</li><li>Check the version of if this is different</li><li>Update/Create the view (I am doing it in production mode here, in real application it will be better to use dev mode - just prefix the design document ID with <code>&quot;dev_&quot;</code> )</li><li>Once the view is created update/create the <code>&quot;app.version&quot;</code> document with the new ID.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>In this article we have seen how you can quickly develop your application/prototype and leverage the flexibility of NoSQL for developers. The steps to do this are:</p><ol><li>Design your document model and API (REST)</li><li>Create the UI that consumes the API</li><li>Modify your model by simply adding field into the UI</li><li>Update the view to adapt your lists to your new model</li></ol><p>In addition to this, I have also quickly explain how you can from your code control the version of your application and deploy new views (and other things) automatically.</p><p>I will post another blog post in few days to explain how you can easily integrate user management, security to your application and database easily</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/page/3"><div class="pagination-nav__label">« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/page/5"><div class="pagination-nav__label">Older Entries »</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCA1kgHJTFZW-MRcr8KX_QYQ" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/tugdualgrall/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2003 -- 2022 Tugdual Grall built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4b9fad76.js"></script>
<script src="/assets/js/main.ea67b1c9.js"></script>
</body>
</html>