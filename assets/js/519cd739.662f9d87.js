(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[44116],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=u(n),h=r,m=d["".concat(s,".").concat(h)]||d[h]||c[h]||o;return n?a.createElement(m,i(i({ref:t},p),{},{components:n})):a.createElement(m,i({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var u=2;u<o;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},59902:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return u},metadata:function(){return p},assets:function(){return c},toc:function(){return d},default:function(){return m}});var a=n(22122),r=n(19756),o=(n(67294),n(3905)),i=n(59943),l=["components"],s={title:"Using Apache Drill REST API to build ASCII Dashboard with node",categories:"Drill SQL node.js dataviz"},u=void 0,p={permalink:"/blog/2015/12/10/using-apache-drill-rest-api-to-build-ascii-dashboard-with-node",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/blog/blog/2015-12-10-using-apache-drill-rest-api-to-build-ascii-dashboard-with-node.md",source:"@site/blog/2015-12-10-using-apache-drill-rest-api-to-build-ascii-dashboard-with-node.md",title:"Using Apache Drill REST API to build ASCII Dashboard with node",description:"Apache Drill has a hidden gem: an easy to use REST interface. This API can be used to Query, Profile and Configure Drill engine.",date:"2015-12-10T00:00:00.000Z",formattedDate:"December 10, 2015",tags:[],readingTime:4.01,truncated:!0,authors:[],prevItem:{title:"Getting Started with Sample Programs for Apache Kafka 0.9",permalink:"/blog/2016/02/10/getting-started-with-sample-programs-for-apache-kafka-0-dot-9"},nextItem:{title:"Convert a CSV File to Apache Parquet with Drill",permalink:"/blog/2015/08/17/convert-csv-file-to-apache-parquet-dot-dot-dot-with-drill"}},c={authorsImageUrls:[]},d=[{value:"The Query and View",id:"the-query-and-view",children:[]},{value:"Use the REST API",id:"use-the-rest-api",children:[]},{value:"Create a Graph using Node.js &amp; Blessed Contrib",id:"create-a-graph-using-nodejs--blessed-contrib",children:[{value:"Run the &quot;Dashboard&quot;",id:"run-the-dashboard",children:[]}]},{value:"Complete Dashboard",id:"complete-dashboard",children:[]}],h={toc:d};function m(e){var t=e.components,s=(0,r.Z)(e,l);return(0,o.kt)("wrapper",(0,a.Z)({},h,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"http://drill.apache.org"},"Apache Drill")," has a hidden gem: an easy to use REST interface. This API can be used to Query, Profile and Configure Drill engine."),(0,o.kt)("p",null,"In this blog post I will explain how to use Drill REST API to create ascii dashboards using ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/blessed-contrib"},"Blessed Contrib"),"."),(0,o.kt)("p",null,"The ASCII Dashboard looks like"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Dashboard",src:n(98001).Z})),(0,o.kt)("h4",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Node.js"),(0,o.kt)("li",{parentName:"ul"},"Apache Drill 1.2"),(0,o.kt)("li",{parentName:"ul"},"For this post, you will use the SFO Passengers CSV file available ",(0,o.kt)("a",{parentName:"li",href:"http://www.flysfo.com/media/facts-statistics/air-traffic-statistics"},"here"),". ",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Download this locally, unzip the files and put the CSV into a folder that will be access uzing the following path in Drill : ",(0,o.kt)("inlineCode",{parentName:"li"},"dfs.data.`/airport/*.csv` "))))),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Note: I am still using Apache 1.2 to allow this example to be executed in context of a MapR cluster.")),(0,o.kt)("h2",{id:"the-query-and-view"},"The Query and View"),(0,o.kt)("p",null,"In Drill 1.2, CSV headers are not automatically parsed. (This is one of the new features of 1.3: look for ",(0,o.kt)("inlineCode",{parentName:"p"},"extractHeader")," in the ",(0,o.kt)("a",{parentName:"p",href:"https://drill.apache.org/docs/text-files-csv-tsv-psv/"},"documentation"),"). "),(0,o.kt)("p",null,"For simplicity, remove the first line of the CSV."),(0,o.kt)("p",null,"The basic query will look like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"SELECT\nCAST(SUBSTR(columns[0],1,4) AS INT)  `YEAR`,\nCAST(SUBSTR(columns[0],5,2) AS INT) `MONTH`,\ncolumns[1] as `AIRLINE`,\ncolumns[2] as `IATA_CODE`,\ncolumns[3] as `AIRLINE_2`,\ncolumns[4] as `IATA_CODE_2`,\ncolumns[5] as `GEO_SUMMARY`,\ncolumns[6] as `GEO_REGION`,\ncolumns[7] as `ACTIVITY_CODE`,\ncolumns[8] as `PRICE_CODE`,\ncolumns[9] as `TERMINAL`,\ncolumns[10] as `BOARDING_AREA`,\nCAST(columns[11] AS DOUBLE) as `PASSENGER_COUNT`\nFROM dfs.data.`/airport/*.csv`\nLIMIT 10\n")),(0,o.kt)("p",null,"Let's now create a view with these columns: ",(0,o.kt)("em",{parentName:"p"},"(do not put any limit !)")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"CREATE OR REPLACE VIEW dfs.tmp.`airport_data_view` AS\nSELECT\nCAST(SUBSTR(columns[0],1,4) AS INT)  `YEAR`,\nCAST(SUBSTR(columns[0],5,2) AS INT) `MONTH`,\ncolumns[1] as `AIRLINE`,\ncolumns[2] as `IATA_CODE`,\ncolumns[3] as `AIRLINE_2`,\ncolumns[4] as `IATA_CODE_2`,\ncolumns[5] as `GEO_SUMMARY`,\ncolumns[6] as `GEO_REGION`,\ncolumns[7] as `ACTIVITY_CODE`,\ncolumns[8] as `PRICE_CODE`,\ncolumns[9] as `TERMINAL`,\ncolumns[10] as `BOARDING_AREA`,\nCAST(columns[11] AS DOUBLE) as `PASSENGER_COUNT`\nFROM dfs.data.`/airport/*.csv`\n")),(0,o.kt)("p",null,"So you can now use the view in your query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"select * from dfs.tmp.`airport_data_view` limit 5;\n")),(0,o.kt)("h2",{id:"use-the-rest-api"},"Use the REST API"),(0,o.kt)("p",null,"Now that you have the query you can use the REST API to retrieve the data as JSON document over HTTP. Open a terminal and run this curl command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'curl  \\\n  --header "Content-type: application/json" \\\n  --request POST \\\n  --data \'{\n    "queryType" : "SQL",\n    "query" : "select * from dfs.tmp.`airport_data_view` limit 5 " }\' \\\n  http://localhost:8047/query.json\n')),(0,o.kt)("p",null,"The returned JSON document looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{\n  "columns" : [ "YEAR", "MONTH", ... , "PASSENGER_COUNT" ],\n  "rows" : [ {\n    "GEO_REGION" : "US",\n    "IATA_CODE_2" : "TZ",\n        ...\n        ...\n    "AIRLINE" : "ATA Airlines",\n    "MONTH" : "7",\n    "ACTIVITY_CODE" : "Deplaned"\n  }, {\n    "GEO_REGION" : "US",\n    "IATA_CODE_2" : "TZ",\n    "GEO_SUMMARY" : "Domestic",\n    ...\n  }\n  ]\n}\n')),(0,o.kt)("p",null,"As you can see it is quite simple:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"a first JSON attribute that list the columns"),(0,o.kt)("li",{parentName:"ul"},"the list of rows, as JSON documents in an array.")),(0,o.kt)("h2",{id:"create-a-graph-using-nodejs--blessed-contrib"},"Create a Graph using Node.js & Blessed Contrib"),(0,o.kt)("p",null,"Let's create a node application. "),(0,o.kt)("p",null,"First you have to include:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"request")," : to call the REST API"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"blessed")," : to get a rich Terminal API"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"blessed-contrib")," : for the dashboard")),(0,o.kt)("p",null,"and then create a ",(0,o.kt)("inlineCode",{parentName:"p"},"screen")," and a ",(0,o.kt)("inlineCode",{parentName:"p"},"bar")," chard from Contrib."),(0,o.kt)("p",null,"So the ",(0,o.kt)("em",{parentName:"p"},"header")," of your Javascript file looks like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"var blessed = require('blessed')\n  , contrib = require('blessed-contrib')\n  , request = require('request')\n  , screen = blessed.screen()\n  , bar = contrib.bar(\n       { label: 'Bar Chart'\n       , barWidth: 20\n       , barSpacing: 20\n       , maxHeight: 9\n       , height: \"100%\"\n       , width: \"100%\"})\n")),(0,o.kt)("p",null,"So here we have defined a bar char, that will be populated with the columns and rows. For this we need a query, let's use the number of passengers per year, as follow:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"SELECT `YEAR`, SUM(`PASSENGER_COUNT`) FROM dfs.tmp.`airport_data_view` GROUP BY `YEAR`\n")),(0,o.kt)("p",null,"The complete Bar Chat application looks like:"),(0,o.kt)(i.Z,{id:"00c5d83b85f59d80ad95",file:"app001.js",mdxType:"Gist"}),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The lines 15-17 contain the query object used by the Drill REST API"),(0,o.kt)("li",{parentName:"ul"},"The lines 26-38 contain the callback from the HTTP call, and the results values are store in the data object (lines 33-34), and then set in the bar chart (line 36)")),(0,o.kt)("h3",{id:"run-the-dashboard"},'Run the "Dashboard"'),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"npm install request blessed blessed-contrib\n\nnode app001.js\n\n")),(0,o.kt)("p",null,"This application shows a simple bar chart, in your terminal. Let's now create a richer dashboard."),(0,o.kt)("h2",{id:"complete-dashboard"},"Complete Dashboard"),(0,o.kt)("p",null,"The Bless-Contrib node package allows developer to create rich dashboards that aggregate multiple graphs and could be refresh automatically, as seen in the screencast at the top of this post."),(0,o.kt)("p",null,"You can find a simple dashboard in this ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/tgrall/drill-node-dashboard.git"},"Github repository"),", once you have cloned it, you just need to run: (be sure that your view is called 'dfs.tmp.",(0,o.kt)("inlineCode",{parentName:"p"},"airport_data_view"),"'"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"git clone https://github.com/tgrall/drill-node-dashboard.git\n\ncd drill-node-dashboard\n\nnpm install\n\nnode dashboard.js http://localhost:8047\n\n")),(0,o.kt)("p",null,"You can even change the CSV file, for example adding new months, and the line chart on the right will be refreshed automatically."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"Note: this dashboard sample is very basic and just a quick example explaning how to use Drill REST API in a node.js application")))}m.isMDXComponent=!0},59943:function(e,t,n){"use strict";var a=n(67294);n(45697);function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var i=function(e){function t(){return r(this,t),o(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._updateIframeContent()},t.prototype.componentDidUpdate=function(e,t){this._updateIframeContent()},t.prototype._defineUrl=function(){var e=this.props,t=e.id,n=e.file;return"https://gist.github.com/"+t+".js"+(n?"?file="+n:"")},t.prototype._updateIframeContent=function(){var e=this.props,t=e.id,n=e.file,a=this.iframeNode,r=a.document;a.contentDocument?r=a.contentDocument:a.contentWindow&&(r=a.contentWindow.document);var o='<html><head><base target="_parent"><style>*{font-size:12px;}</style></head><body '+("onload=\"parent.document.getElementById('"+(n?"gist-"+t+"-"+n:"gist-"+t)+"').style.height=document.body.scrollHeight + 'px'\"")+">"+('<script type="text/javascript" src="'+this._defineUrl()+'"><\/script>')+"</body></html>";r.open(),r.writeln(o),r.close()},t.prototype.render=function(){var e=this,t=this.props,n=t.id,r=t.file;return a.createElement("iframe",{ref:function(t){e.iframeNode=t},width:"100%",frameBorder:0,id:r?"gist-"+n+"-"+r:"gist-"+n})},t}(a.PureComponent);t.Z=i},98001:function(e,t,n){"use strict";t.Z=n.p+"assets/images/dashboard_demo-b5ddedf89587391e12ef9f1c7b473a1b.gif"}}]);