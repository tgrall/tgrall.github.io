"use strict";(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[65607],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return d}});var n=a(67294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,s=function(e,t){if(null==e)return{};var a,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var l=n.createContext({}),m=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=m(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,s=e.mdxType,r=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=m(a),d=s,h=c["".concat(l,".").concat(d)]||c[d]||u[d]||r;return a?n.createElement(h,i(i({ref:t},p),{},{components:a})):n.createElement(h,i({ref:t},p))}));function d(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=a.length,i=new Array(r);i[0]=c;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:s,i[1]=o;for(var m=2;m<r;m++)i[m]=a[m];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},24585:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return m},assets:function(){return p},toc:function(){return u},default:function(){return d}});var n=a(87462),s=a(63366),r=(a(67294),a(3905)),i=["components"],o={title:"Getting Started with Redis Streams and Java",tags:["redis","nosql","stream","streaming","java"]},l=void 0,m={permalink:"/blog/2019/09/02/getting-with-redis-streams-and-java",editUrl:"https://github.dev/tgrall/tgrall.github.io/blob/main/blog/2019-09-02-getting-with-redis-streams-and-java.md",source:"@site/blog/2019-09-02-getting-with-redis-streams-and-java.md",title:"Getting Started with Redis Streams and Java",description:"As you may have seen, I have joined Redis Labs a month ago; one of the first task as a new hire is to learn more about Redis. So I learned, and I am still learning.",date:"2019-09-02T00:00:00.000Z",formattedDate:"September 2, 2019",tags:[{label:"redis",permalink:"/blog/tags/redis"},{label:"nosql",permalink:"/blog/tags/nosql"},{label:"stream",permalink:"/blog/tags/stream"},{label:"streaming",permalink:"/blog/tags/streaming"},{label:"java",permalink:"/blog/tags/java"}],readingTime:7.77,truncated:!0,authors:[],prevItem:{title:"Multi-Nodes Redis Cluster with Docker",permalink:"/blog/2019/09/04/multi-nodes-redis-cluster-with-docker"},nextItem:{title:"Getting Started With MapR-DB JSON REST API",permalink:"/blog/2018/05/23/getting-started-with-mapr-db-json-rest-api"}},p={authorsImageUrls:[]},u=[{value:"Java &amp; Redis Streams",id:"java--redis-streams",children:[]},{value:"Build &amp; Run the Simple Java Application",id:"build--run-the-simple-java-application",children:[]},{value:"Conclusion",id:"conclusion",children:[]}],c={toc:u};function d(e){var t=e.components,o=(0,s.Z)(e,i);return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"As you may have seen, I have joined ",(0,r.kt)("a",{parentName:"p",href:"https://www.redislabs.com"},"Redis Labs")," a month ago; one of the first task as a new hire is to learn more about Redis. So I learned, and I am still learning."),(0,r.kt)("p",null,"This is when I discovered ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/topics/streams-intro"},"Redis Streams"),". I am a big fan of streaming-based applications so it is natural that I start with a small blog post explaining how to use Redis Streams and Java."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"What is Redis Streams?"))),(0,r.kt)("p",null,"Redis Streams is a Redis Data Type, that represents a log so you can add new information/message in an append-only mode ",(0,r.kt)("em",{parentName:"p"},"(this is not 100% accurate since you can remove messages from the log)"),'. Using Redis Streams you can build "Kafka Like" applications, what I mean by that you can:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"create applications that publish and consume messages (nothing extraordinary here, you could already do that with Redis Pub/Sub)"),(0,r.kt)("li",{parentName:"ul"},"consume messages that are published even when your client application (consumer) is not running. This is a big difference with Redis Pub/Sub"),(0,r.kt)("li",{parentName:"ul"},"consume messages starting a specific offset, for example, read the whole history, or only new messages")),(0,r.kt)("p",null,"In addition to this, Redis Streams has the concept of ",(0,r.kt)("strong",{parentName:"p"},"Consumer Groups"),". Redis Streams Consumer Groups, like Apache Kafka ones, allows the client applications to consume messages in a distributed fashion (multiple clients), providing an easy way to scale and create highly available systems."),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(36599).Z})),(0,r.kt)("p",null,"Enroll in the ",(0,r.kt)("a",{parentName:"p",href:"https://university.redislabs.com/courses/course-v1:redislabs+RU202+2019_03/about"},"Redis University: Redis Streams")," to learn more and get certified."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("em",{parentName:"strong"},"Sample Application"))),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tgrall/redis-streams-101-java"},"redis-streams-101-java GitHub Repository")," contains sample code that shows how to"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"post messages to a streams"),(0,r.kt)("li",{parentName:"ul"},"consume messages using a consumer group")),(0,r.kt)("h4",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Redis 5.x, you have here multiple options:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://redis.io"},"Download")," and install Redis Community"),(0,r.kt)("li",{parentName:"ul"},"Install and Run a Docker image: ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/redis"},"Community")," or ",(0,r.kt)("a",{parentName:"li",href:"https://hub.docker.com/r/redislabs/redis"},"Redis Enterprise")," "),(0,r.kt)("li",{parentName:"ul"},"Create a online instance on ",(0,r.kt)("a",{parentName:"li",href:"https://redislabs.com/redis-enterprise/essentials/"},"Redis Labs Cloud")," (30mb for free)"))),(0,r.kt)("li",{parentName:"ul"},"Java 8 or later"),(0,r.kt)("li",{parentName:"ul"},"Apache Maven 3.5.x"),(0,r.kt)("li",{parentName:"ul"},"Git")),(0,r.kt)("h3",{id:"java--redis-streams"},"Java & Redis Streams"),(0,r.kt)("p",null,"Redis has many Java clients developed by the community, as you can see on the ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/clients#java"},"Redis.io site"),"."),(0,r.kt)("p",null,"It looks, based on my short experience with Redis so far, that the most complete one around Redis Streams support is ",(0,r.kt)("a",{parentName:"p",href:"https://lettuce.io"},"Lettuce"),", this is the one I will be using in the following code."),(0,r.kt)("p",null,"####1- Adding Lettuce to Your Maven Project"),(0,r.kt)("p",null,"Add the following dependency to your project file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},"        <dependency>\n            <groupId>io.lettuce</groupId>\n            <artifactId>lettuce-core</artifactId>\n            <version>5.1.8.RELEASE</version>\n        </dependency>\n")),(0,r.kt)("p",null,"####2- Connecting to Redis"),(0,r.kt)("p",null,"Import the following classes"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"import io.lettuce.core.*;\nimport io.lettuce.core.api.StatefulRedisConnection;\nimport io.lettuce.core.api.sync.RedisCommands;\n")),(0,r.kt)("p",null,"Then connect with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'RedisClient redisClient = RedisClient.create("redis://password@host:port"); // change to reflect your environment\nStatefulRedisConnection<String, String> connection = redisClient.connect();\nRedisCommands<String, String> syncCommands = connection.sync();\n')),(0,r.kt)("p",null,"When your application is done with the connection you should disconnect with the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},"connection.close();\nredisClient.shutdown();\n")),(0,r.kt)("p",null,"####3- Sending Message to Streams"),(0,r.kt)("p",null,"Once you have a connection you can send a message. In this example, I will let Redis generate the message ID, which is time-based, and the body will be built using a Map representing IoT data, for example, a weather data capturing Wind speed and direction in real-time."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'    public static void main(String[] args) {\n\n        RedisClient redisClient = RedisClient.create("redis://localhost:6379"); // change to reflect your environment\n        StatefulRedisConnection<String, String> connection = redisClient.connect();\n        RedisCommands<String, String> syncCommands = connection.sync();\n\n        Map<String, String> messageBody = new HashMap<>();\n        messageBody.put( "speed", "15" );\n        messageBody.put( "direction", "270" );\n        messageBody.put( "sensor_ts", String.valueOf(System.currentTimeMillis()) );\n\n        String messageId = syncCommands.xadd(\n                "weather_sensor:wind",\n                messageBody);\n\n        System.out.println( String.format("Message %s : %s posted", messageId, messageBody) );\n\n        connection.close();\n        redisClient.shutdown();\n\n    }\n\n')),(0,r.kt)("p",null,"Let me explain the code:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Lines 3-5 are used to connect to Redis"),(0,r.kt)("li",{parentName:"ul"},"Lines 7-10 are used to create the message body, using a Map, since Redis Streams messages are string key/values."),(0,r.kt)("li",{parentName:"ul"},"Lines 12-14 call the ",(0,r.kt)("inlineCode",{parentName:"li"},"syncCommands.xadd()"),' method using the streams key "weather_sensor:wind" and the message body itself',(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"this method returns the message ID."))),(0,r.kt)("li",{parentName:"ul"},"line 16 just print the message ID and content"),(0,r.kt)("li",{parentName:"ul"},"the lines 18-19 close the connection and client.")),(0,r.kt)("p",null,"The complete producer code is available ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tgrall/redis-streams-101-java/blob/master/src/main/java/com/kanibl/redis/streams/simple/RedisStreams101Producer.java"},"here"),"."),(0,r.kt)("p",null,"####4- Consuming Messages"),(0,r.kt)("p",null,"Redis Streams offers various way to consume/read messages using the commands: ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/commands/xrange"},"XRANGE"),", ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/commands/xrevrange"},"XREVRANGE"),", ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/commands/xread"},"XREAD"),", ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/commands/xreadgroup"},"XREADGROUP"),"."),(0,r.kt)("p",null,"I want to keep the article short and close to the way you would build an application with Apache Kafka, this is why I will use the ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/commands/xreadgroup"},"XREADGROUP")," command from Lettuce."),(0,r.kt)("p",null,"The Consumer Groups allow developers to create a group of clients that will cooperate to consume messages from the streams (for scale and high availability); it is also a way to associate the client to specific applications roles; for example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},'a consumer group called "data warehouse" will consume messages and send them to a data warehouse'),(0,r.kt)("li",{parentName:"ul"},'another consumer group called "aggregator" will consume the messages and aggregate the data and send them to another sink (another stream or storage)')),(0,r.kt)("p",null,'Each of this group will act independently, and each of this group could have multiple "consumers" (client).'),(0,r.kt)("p",null,"Let's see how you use this in Java."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'...\n\n        try {\n            // WARNING: Streams must exist before creating the group\n            //          This will not be necessary in Lettuce 5.2, see https://github.com/lettuce-io/lettuce-core/issues/898\n            syncCommands.xgroupCreate( XReadArgs.StreamOffset.from("weather_sensor:wind", "0-0"), "application_1"  );\n        }\n        catch (RedisBusyException redisBusyException) {\n            System.out.println( String.format("\\t Group \'%s already\' exists","application_1"));\n        }\n\n\n        System.out.println("Waiting for new messages");\n\n        while(true) {\n\n            List<StreamMessage<String, String>> messages = syncCommands.xreadgroup(\n                    Consumer.from("application_1", "consumer_1"),\n                    XReadArgs.StreamOffset.lastConsumed("weather_sensor:wind")\n            );\n\n            if (!messages.isEmpty()) {\n                for (StreamMessage<String, String> message : messages) {\n                    System.out.println(message);\n                    // Confirm that the message has been processed using XACK\n                    syncCommands.xack(STREAMS_KEY, "application_1",  message.getId());\n                }\n            }\n\n\n        }\n\n...\n')),(0,r.kt)("p",null,"This code is a subset of the ",(0,r.kt)("inlineCode",{parentName:"p"},"main()")," method I have removed the connection management part, to add readability. Let's take a look to the code:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"line 3 to 10, using the method ",(0,r.kt)("inlineCode",{parentName:"li"},"xgroupCreate()"),", that matches the ",(0,r.kt)("a",{parentName:"li",href:"https://redis.io/commands/xgroup"},"XGROUP CREATE")," command,",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"is used to create a new group called ",(0,r.kt)("inlineCode",{parentName:"li"},"application_1"),","),(0,r.kt)("li",{parentName:"ul"},"consume messages from the stream ",(0,r.kt)("inlineCode",{parentName:"li"},"weather_sensor:wind")," "),(0,r.kt)("li",{parentName:"ul"},"starting at the first message in the stream, this is indicated using the message ID ",(0,r.kt)("inlineCode",{parentName:"li"},"0-0"),". ",(0,r.kt)("em",{parentName:"li"},"Note that it is also possible to indicate to the group to start to read at a specific message ID, or only the new messages that arrive after the creating of the consumer group using ",(0,r.kt)("inlineCode",{parentName:"em"},"$")," special ID (or the helper method ",(0,r.kt)("inlineCode",{parentName:"em"},"XReadArgs.StreamOffset.latest()")),"."))),(0,r.kt)("li",{parentName:"ul"},"line 15 to 30, in this example we use an infinite loop (",(0,r.kt)("inlineCode",{parentName:"li"},"while(true)"),") to wait for any new messages published to the streams"),(0,r.kt)("li",{parentName:"ul"},"line 17 to 20, the method ",(0,r.kt)("inlineCode",{parentName:"li"},"xreadgroup()")," returns the messages based on the group configuration",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"line 18 define the consumer named ",(0,r.kt)("inlineCode",{parentName:"li"},"consumer_1")," that is associated with the group ",(0,r.kt)("inlineCode",{parentName:"li"},"application_1"),": you can create new group do distribute the read to multiple clients"),(0,r.kt)("li",{parentName:"ul"},"line 19 indicates where to start, in this case, ",(0,r.kt)("inlineCode",{parentName:"li"},'StreamOffset.lastConsumed("weather_sensor:wind")')," the consumer will consume messages that have not been read already. With the current configuration of the group (offset ",(0,r.kt)("inlineCode",{parentName:"li"},"0-0"),"), when the consumer will start for the first time, it will read all the existing messages."))),(0,r.kt)("li",{parentName:"ul"},"line 22 to 28, the application iterates on each messages, and:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"line 24, process the message, a simple print in this case"),(0,r.kt)("li",{parentName:"ul"},"line 26, sends a acknowledgment using ",(0,r.kt)("inlineCode",{parentName:"li"},"xack()")," command. You have to use the ack command to confirm that a message has been read and processed. The ",(0,r.kt)("a",{parentName:"li",href:"https://redis.io/commands/xack"},(0,r.kt)("inlineCode",{parentName:"a"},"XACK"))," command removes the message from the pending list of the consumer group.")))),(0,r.kt)("p",null,"The complete consumer code is available ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tgrall/redis-streams-101-java/blob/master/src/main/java/com/kanibl/redis/streams/simple/RedisStreams101Consumer.java"},"here"),"."),(0,r.kt)("h3",{id:"build--run-the-simple-java-application"},"Build & Run the Simple Java Application"),(0,r.kt)("p",null,"Now that you have a better understanding of the code, let's run the producer and consumer. You can run this from your IDE, or using Maven."),(0,r.kt)("p",null,"Let's do it using Maven CLI, for this open 2 terminals:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"one to produce messages"),(0,r.kt)("li",{parentName:"ul"},"one to consume them")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"1- Clone and Build the project")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"> git clone https://github.com/tgrall/redis-streams-101-java.git\n\n> cd redis-streams-101-java\n\n> mvn clean verify\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"2- Post a new message")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\n> mvn exec:java -Dexec.mainClass="com.kanibl.redis.streams.simple.RedisStreams101Producer"\n\n')),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"3- Consume messages")),(0,r.kt)("p",null,"Open a new terminal and run the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\n> mvn exec:java -Dexec.mainClass="com.kanibl.redis.streams.simple.RedisStreams101Consumer"\n\n')),(0,r.kt)("p",null,"The consumer will start and consume the message you just posted, and wait for any new messages."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"4- In the first terminal post 100 new messages")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\n> mvn exec:java -Dexec.mainClass="com.kanibl.redis.streams.simple.RedisStreams101Producer" -Dexec.args="100"\n\n')),(0,r.kt)("p",null,"The consumer will receive and print all the messages."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"5- Kill the consumer and post more messages")),(0,r.kt)("p",null,"Let's now do another test, stop the consumer using a simple ",(0,r.kt)("inlineCode",{parentName:"p"},"ctrl+C"),"."),(0,r.kt)("p",null,"Then post 5 new messages."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\n> mvn exec:java -Dexec.mainClass="com.kanibl.redis.streams.simple.RedisStreams101Producer" -Dexec.args="5"\n\n')),(0,r.kt)("p",null,"The messages are not yet consumed by any application, but still store in Redis Streams."),(0,r.kt)("p",null,"So when you start the consumer, it will consumes these new messages."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'\n> mvn exec:java -Dexec.mainClass="com.kanibl.redis.streams.simple.RedisStreams101Consumer"\n\n')),(0,r.kt)("p",null,"This is a one of the differences between ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/topics/streams-intro"},"Redis Streams")," and ",(0,r.kt)("a",{parentName:"p",href:"https://redis.io/topics/pubsub"},"Redis PubSub"),". The producer application has publish many messages while the consumer application was not running. Since the consumer is ran with ",(0,r.kt)("inlineCode",{parentName:"p"},"StreamOffset.lastConsumed()"),", when the consumer is starting, it looks to the last consumed ID, and start to read the streams from there. This method generate a XGROUPREAD command with the group"),(0,r.kt)("h3",{id:"conclusion"},"Conclusion"),(0,r.kt)("p",null,"In this small project, you have learned, how to use Lettuce, a Java client for Redis to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"publish messages to a stream"),(0,r.kt)("li",{parentName:"ul"},"create a consumer group"),(0,r.kt)("li",{parentName:"ul"},"consume messages using the consumer group.")),(0,r.kt)("p",null,"This is a very basic example, and in a next post I will show you how to work with multiple consumers, and to configure the Consumer Group and Consumers to control which messages you want to read"),(0,r.kt)("p",null,"More to come!"))}d.isMDXComponent=!0},36599:function(e,t,a){t.Z=a.p+"assets/images/redis-streams-101-img-1-2968c7ae8874c27aa176d161aa05a1d1.png"}}]);