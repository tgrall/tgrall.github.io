(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[54977],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(n),h=o,m=d["".concat(s,".").concat(h)]||d[h]||c[h]||r;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},12920:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return p},metadata:function(){return u},assets:function(){return c},toc:function(){return d},default:function(){return m}});var a=n(22122),o=n(19756),r=(n(67294),n(3905)),i=n(59943),l=["components"],s={title:"Introduction to Collated Views with Couchbase 2.0",tags:["couchbase","nosql","view","json"]},p=void 0,u={permalink:"/blog/2013/02/13/introduction-to-collated-views-with-couchbase-2-dot-0",editUrl:"https://github.dev/tgrall/tgrall.github.io/blob/main/blog/2013-02-13-introduction-to-collated-views-with-couchbase-2-dot-0.md",source:"@site/blog/2013-02-13-introduction-to-collated-views-with-couchbase-2-dot-0.md",title:"Introduction to Collated Views with Couchbase 2.0",description:'Most of the applications have to deal with "master/detail" type of data:',date:"2013-02-13T00:00:00.000Z",formattedDate:"February 13, 2013",tags:[{label:"couchbase",permalink:"/blog/tags/couchbase"},{label:"nosql",permalink:"/blog/tags/nosql"},{label:"view",permalink:"/blog/tags/view"},{label:"json",permalink:"/blog/tags/json"}],readingTime:4.755,truncated:!1,authors:[],prevItem:{title:"How to get the latest document by date/time field?",permalink:"/blog/2013/02/18/how-to-get-the-latest-document-by-date-slash-time-field"},nextItem:{title:"Getting started with Couchbase and node.js on Windows",permalink:"/blog/2013/01/04/getting-started-with-couchbase-and-node-dot-js-on-windows"}},c={authorsImageUrls:[]},d=[{value:"The Data",id:"the-data",children:[]},{value:"The View",id:"the-view",children:[]},{value:"The Beer Sample Application",id:"the-beer-sample-application",children:[]}],h={toc:d};function m(e){var t=e.components,n=(0,o.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,'Most of the applications have to deal with "master/detail" type of data:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"breweries and beer"),(0,r.kt)("li",{parentName:"ul"},"department and employees"),(0,r.kt)("li",{parentName:"ul"},"invoices and items"),(0,r.kt)("li",{parentName:"ul"},"...")),(0,r.kt)("p",null,"This is necessary for example to create application view like the following:\n",(0,r.kt)("img",{parentName:"p",src:"http://1.bp.blogspot.com/-vdpPEX_Wfm0/URt23LU3r1I/AAAAAAAAAbA/rDykow-eQY4/s320/Screen+Shot+2013-02-13+at+12.19.11+PM.png",alt:null})),(0,r.kt)("p",null,"With Couchbase, and many of the document oriented databases you have different ways to deal with this, you can:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Create a single document for each master and embed all the children in it"),(0,r.kt)("li",{parentName:"ul"},"Create a master and child documents and link them using an attribute.")),(0,r.kt)("p",null,"In the first case when all the information are stored in a single document it is quite easy to use the entire set of data and for example create a screen that shows all the information, but what about the second case?"),(0,r.kt)("p",null,"In this post I am explaining how it is possible to use Couchbase views to deal with that an make it easy to create master/detail views."),(0,r.kt)("p",null,"As an ex-Oracle employee, I am using the infamous SCOTT schema with the DEPT and EMP tables, as the first example. Then at the end I will extend this to the beer sample data provided with Couchbase."),(0,r.kt)("h3",{id:"the-data"},"The Data"),(0,r.kt)("p",null,"Couchbase is a schema-less database, and you can store \u201canything you want\u201d into it, but for this you need to use JSON documents and create 2 types of document : \u201cdepartment\u201d and \u201cemployee\u201d."),(0,r.kt)("p",null,"The way we usually do that is using a technical attribute to type the document. So the employee and department document will look as follow :"),(0,r.kt)("p",null,"Department"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "dept",\n  "id": 10,\n  "name": "Accounting",\n  "city": "New York"\n}\n')),(0,r.kt)("p",null,"Employee"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "type": "emp",\n  "id": 7782,\n  "name": "Blake",\n  "job": "Clark",\n  "manager": 7839,\n  "salary": 2450,\n  "dept_id": "dept__10"\n}\n')),(0,r.kt)("p",null,"This shows just the document, in Couchbase you have to associate a document to a key. For this example I am using a simple pattern : ",(0,r.kt)("inlineCode",{parentName:"p"},"type__id"),", for these documents the keys will look like the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dept__10")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"emp__20"))),(0,r.kt)("p",null,"You can use any pattern to create a key, for example for the employee you could chose to put an email."),(0,r.kt)("p",null,"Note the \u201cdept_id\u201d attribute in the employee document. This is the key of the department; you can see that as the \u201cforeign key\u201d. But remember, the relationship between the department and employee documents are managed entirely by the application, Couchbase Server does not enforce it."),(0,r.kt)("p",null,"I have created a Zip file that contains all the data, you can download it from ",(0,r.kt)("a",{parentName:"p",href:"http://db.tt/NsUfweBM"},"here"),"; and import the data into Couchbase using the ",(0,r.kt)("inlineCode",{parentName:"p"},"cbdocloader")," utility. To import the data run the following command from a terminal window:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"./cbdocloader -n 127.0.0.1:8091 -u Administrator -p password -b default ~/Downloads/emp-dept.zip\n")),(0,r.kt)("p",null,"You can learn more about the ",(0,r.kt)("inlineCode",{parentName:"p"},"cbdocloader")," tool in ",(0,r.kt)("a",{parentName:"p",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-admin-cmdline-cbdocloader.html"},"the documentation"),"."),(0,r.kt)("h3",{id:"the-view"},"The View"),(0,r.kt)("p",null,"Queries inside Couchbase are based on ",(0,r.kt)("a",{parentName:"p",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-basics.html"},"views"),'; and views build indexes, so we have to create a view, a "collated view" to be exact.'),(0,r.kt)("p",null,"The idea behing a collated view is to produce an index where the keys are ordered so that a parent id appears first followed by its children. So we are generating an index that will look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"DEPT_10, Accounting\nDEPT_10, Blake\nDEPT_10, Miller\nDEPT_20, Research\nDEPT_20, Adams\nDEPT_20, Ford\n...\n")),(0,r.kt)("p",null,"This is in fact quite easy to do with Couchbase views. The only trick here is to control the order and be sure the master is always the first one, just before its children."),(0,r.kt)("p",null,'So to control this we can create an compound key that contains the department id, a "sorting" element and the name (beer or brewery)'),(0,r.kt)("p",null,"So the map function of the view looks like the following:"),(0,r.kt)(i.Z,{id:"bfb625e0ff175b1778bc",mdxType:"Gist"}),(0,r.kt)("p",null,"The key is composed of:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the department id extracted from the department document itself or from the employee document depending of the type of document"),(0,r.kt)("li",{parentName:"ul"},"an arbitrary number that is used to control the ordering. I put 0 for the department, 1 for the employee"),(0,r.kt)("li",{parentName:"ul"},"the name of the department or the employee, this also allows to sort the result by name")),(0,r.kt)("p",null,"In addition to the key, this view is used to emit some information about the salary of the employees. The salary is simply the sum of the salary plus thecommission when exists. The result of the view looks like:"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://2.bp.blogspot.com/-wLmoUPfo-f8/URtierY_qBI/AAAAAAAAAaw/i3DMCvilCcU/s400/Screen+Shot+2013-02-13+at+10.52.30+AM.png",alt:null})),(0,r.kt)("p",null,"With this view you can now use the result of the view to build report for your application. It is also possible to use parameters in your query to see only a part of the data, for example by departement, using for example ",(0,r.kt)("inlineCode",{parentName:"p"},'startkey=["dept__20",0]&amp;endkey=["dept__20",2]')," to view only the data -Department and Employees- of the deparment 20-Research."),(0,r.kt)("h3",{id:"the-beer-sample-application"},"The Beer Sample Application"),(0,r.kt)("p",null,'You can create an equivalent view for the beer sample application where you print all the breweries and beers in the same report. The view is called "',(0,r.kt)("inlineCode",{parentName:"p"},"all_with_beers"),'" in the design document "',(0,r.kt)("inlineCode",{parentName:"p"},"brewery"),'". The view looks like:'),(0,r.kt)(i.Z,{id:"4944154",mdxType:"Gist"}),(0,r.kt)("p",null,"Once you have publish it in production you can use it in the Beer Sample application, for this example I have modified the Java sample application."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Create a servlet to handle user request and on the /all URI.")),(0,r.kt)("p",null,'The "BreweryAndBeerServlet" that calls the view using the following code :'),(0,r.kt)(i.Z,{id:"4944142",mdxType:"Gist"}),(0,r.kt)("p",null,"The result of the query is set into the HttpRequest and the all.jsp page is executed. The JSP uses JSTL to print the information using the following code:"),(0,r.kt)(i.Z,{id:"c163f57778d663632e87",mdxType:"Gist"}),"The JSP gets the items from the HTTP Request and loops on each items, then based on the type of the item the information is printed. The final result looks like :",(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"http://1.bp.blogspot.com/-vdpPEX_Wfm0/URt23LU3r1I/AAAAAAAAAbA/rDykow-eQY4/s320/Screen+Shot+2013-02-13+at+12.19.11+PM.png",alt:null})),(0,r.kt)("p",null,"This extension to the Beer Sample application is available here :",(0,r.kt)("a",{parentName:"p",href:"https://github.com/tgrall/beersample-java/tree/BreweriesAndBeers"},"https://github.com/tgrall/beersample-java/tree/BreweriesAndBeers")))}m.isMDXComponent=!0},59943:function(e,t,n){"use strict";var a=n(67294);n(45697);function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var i=function(e){function t(){return o(this,t),r(this,e.apply(this,arguments))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){this._updateIframeContent()},t.prototype.componentDidUpdate=function(e,t){this._updateIframeContent()},t.prototype._defineUrl=function(){var e=this.props,t=e.id,n=e.file;return"https://gist.github.com/"+t+".js"+(n?"?file="+n:"")},t.prototype._updateIframeContent=function(){var e=this.props,t=e.id,n=e.file,a=this.iframeNode,o=a.document;a.contentDocument?o=a.contentDocument:a.contentWindow&&(o=a.contentWindow.document);var r='<html><head><base target="_parent"><style>*{font-size:12px;}</style></head><body '+("onload=\"parent.document.getElementById('"+(n?"gist-"+t+"-"+n:"gist-"+t)+"').style.height=document.body.scrollHeight + 'px'\"")+">"+('<script type="text/javascript" src="'+this._defineUrl()+'"><\/script>')+"</body></html>";o.open(),o.writeln(r),o.close()},t.prototype.render=function(){var e=this,t=this.props,n=t.id,o=t.file;return a.createElement("iframe",{ref:function(t){e.iframeNode=t},width:"100%",frameBorder:0,id:o?"gist-"+n+"-"+o:"gist-"+n})},t}(a.PureComponent);t.Z=i}}]);