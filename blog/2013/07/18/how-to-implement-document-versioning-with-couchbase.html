<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tug&#39;s Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tug&#39;s Site Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-1520374-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">How to implement Document Versioning with Couchbase | Tug&#x27;s Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://tgrall.github.io/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="How to implement Document Versioning with Couchbase | Tug&#x27;s Site"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2013-07-18T00:00:00.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tgrall.github.io/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/2013/07/18/how-to-implement-document-versioning-with-couchbase" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.acbe81c6.css">
<link rel="preload" href="/assets/js/runtime~main.4098db9b.js" as="script">
<link rel="preload" href="/assets/js/main.4630fbc5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Tug&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://windr.org" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Windsurfing App<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/tgrall/tgrall.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/07/how-to-write-a-github-action-annotation-api">Write GitHub Action: Checks and Annotations API (Part 2)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/30/how-to-write-a-github-action">How to Write Custom GitHub Action (Part 1)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/05/16/simple-caching-service-with-redis">Simple caching service with Redis</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/01/02/how-to-use-ssl-slash-tls-with-redis-enterprise">How to use SSL/TLS with Redis Enterprise</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2019/09/19/redis-rolling-upgrade-on-pivotal-cloud-foundry-pcf">Redis Rolling Upgrade on Pivotal Cloud Foundry (PCF)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">How to implement Document Versioning with Couchbase</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2013-07-18T00:00:00.000Z" itemprop="datePublished">July 18, 2013</time> Â· 7 min read</div></header><div class="markdown" itemprop="articleBody"><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h3><p>Developers are often asking me how to &quot;version&quot; documents with Couchbase 2.0. The short answer is: the clients and server do not expose such feature, but it is quite easy to implement.</p><p>In this article I will use a basic approach, and you will be able to extend it depending of your business requirements.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="design"></a>Design<a class="hash-link" href="#design" title="Direct link to heading">#</a></h3><p>The first thing to do is to select how to &quot;store/organize&quot; the versions of your document, and for this you have different designs:</p><ul><li>copy the versions the document into new documents</li><li>copy the versions of the document into a list of embedded documents</li><li>store the list of attributes that have been changed into a embedded element (or new documents)</li><li>store the &quot;delta&quot;</li><li>â€¦</li></ul><p>You will have to chose the design based on your application requirements (business logic, size of the dataset, ...).  For this article, let&#x27;s use one of the most simplistic approach: create new document for each version with the following rules for the keys:</p><ol><li>The current version is is a simple Key/Document, no change to the key.</li><li>The version is a copy of the document, and the version number is added to the key.</li></ol><p>This looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Current Version   mykey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Version 1         mykey::v1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Version 2         mykey::v2</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...               ...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this approach, existing applications will always use the current version of the document, since the key is not changed. But this approach creates new documents that will be indexed by existing views.</p><p>For example, in the Beer Sample application, the following view is used to list the beer by name:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">doc</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> meta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">amp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">amp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;beer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It is quite simple to &quot;support&quot; versioning without impacting the existing code, except the view itself. The new view needs to emit keys,value only for the current version of the document. This is the new view code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">function (doc, meta) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  if(doc.type &amp;amp;&amp;amp; doc.type == &quot;beer&quot; &amp;amp;&amp;amp; (meta.id).indexOf(&quot;::v&quot;) == -1   ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    emit(doc.name);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this change the existing applications that are using this view will continue to work with the same behavior.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="implementing-the-versioning"></a>Implementing the versioning<a class="hash-link" href="#implementing-the-versioning" title="Direct link to heading">#</a></h3><p>Based on this design, when the application needs to version the document, the following logic should happen:</p><ol><li>Get the current version of the document</li><li>Increment the version number (for example using another key that maintains the version number for each document)</li><li>Create the version with the new key  &quot;mykey::v1&quot;</li><li>Save the document current version</li></ol><p>Let&#x27;s look at the code in Java</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Object obj = client.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (obj != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // get the next version, create or use the key: mykey_version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  long version = client.incr(key + &quot;_version&quot;, 1, 1);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String keyForVersion = key + &quot;::v&quot; + version; // mykey::v1</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    client.set(keyForVersion, obj).get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      logger.severe(&quot;Cannot save version &quot;+ version + &quot; for key &quot;+ key +&quot; - Error:&quot;+ e.getMessage() );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.set(key, value);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Quite simple isn&#x27;t?</p><p>The application can access the document using the key, but also get one version or the list of all versions, this is one of the reasons why it is interesting to create a key (<code>mykey_version</code>), and use it also to delete documents and related versions.</p><p>Based on the previous comment, the delete operation looks like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Object obj = client.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// need to delete all the version first</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Object vObject = this.get(key + &quot;_version&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (vObject != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  long biggerVersion = Long.parseLong((String) vObject);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // delete all the versions</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (int i = 1; i &lt;= biggerVersion; i++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      String versionKey = key + &quot;::v&quot; + i;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      client.delete(versionKey).get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // delete the counter</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    client.delete(key + &quot;_version&quot;).get();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (InterruptedException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (ExecutionException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">client.delete(key);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="use-versioning"></a>Use versioning<a class="hash-link" href="#use-versioning" title="Direct link to heading">#</a></h4><p>As an example, I have created a small library available on GitHub <a href="https://github.com/tgrall/couchbase-how-to-versioning" target="_blank" rel="noopener noreferrer">https://github.com/tgrall/couchbase-how-to-versioning</a>, this library extends the Couchbase Client and overrides some of the operations : set, replace and delete. (the basic one: no TLL, no durability) As I said before this is just an example.</p><p><em>Build and Install</em></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/tgrall/couchbase-how-to-versioning.git</span></span><span class="token-line" style="color:#393A34"><span class="token plain">cd how-to-versioning</span></span><span class="token-line" style="color:#393A34"><span class="token plain">mvn clean install</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Then add this library to your project in addition to Couchbase Java Client, for example in your pom.xml</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.couchbase.howtos</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase-how-to-versioning</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.0-SNAPSHOT</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase-client</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.1.8</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Code your application</em></p><p>Create a document and version it:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;uri&gt; uris = new LinkedList&lt;uri&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uris.add(URI.create(&quot;http://127.0.0.1:8091/pools&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CouchbaseClientWithVersioning client = null</span></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client = new CouchbaseClientWithVersioning(uris, &quot;default&quot;, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  String key = &quot;key-001&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.set(key, &quot;This is the original version&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;Original &#x27;%s&#x27; .\n&quot;, client.get(key));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.set(key, &quot;This is a new version&quot;, true); // create a new version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;Current Version &#x27;%s&#x27; .\n&quot;, client.get(key));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;Version 1 &#x27;%s&#x27; .\n&quot;, client.get(key, 1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.set(key, &quot;This is another version&quot;, true); // create a new version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;All versions %s .\n&quot;, client.getAllVersions(key));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.deleteVersion(key, 1); // create a new version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;All versions %s (after delete 1 version).\n&quot;, client.getAllVersions(key));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.delete(key); // create a new version</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  System.out.printf(&quot;All versions %s (after delete the main key).\n&quot;, client.getAllVersions(key));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  e.printStackTrace();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">if (client !=null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Quick explanation:</p><ul><li>Line 5: instead of using the <code>CouchbaseClient</code>, the application uses the extended <code>CouchbaseClientWithVersioning</code> class.</li><li>Line 7: create a new entry</li><li>Line 9: create a new version, the boolean value to &quot;true&quot; force the versioning of the document</li><li>The application use other methods such as get a specific version (line 11), get all versions (line 13), delete a specific version (line 14), and finally delete the key and all versions (line 16).</li></ul><p>So using this approach the developer controls explicitly when to create a version, since he has to add the boolean parameter in the set operation. In this small sample library it is also possible to do auto versioning, in this case all set and replace calls will create a version, to achieve that the developer just needs to call the setAutoVersioning(true) method. Something like:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">client = new CouchbaseClientWithVersioning(uris, &quot;default&quot;, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">client.setAutomaticVersionning(true);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>With this approach you can provide versioning to your application with minimal code change. You can test it in the Beer Sample application, just do not forget to change the views as documenter above to only return <em>current</em> version of the documents.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>As you can see doing versioning in Couchbase is not that complicated, but it is something that must be done by your application based on its requirements and constraints. You have many different solution and none of these options is perfect for all use cases.</p><p>In this specific sample code, I am working with a simple design where I create a copy of the documents for each version. With this approach also, it is interesting to mention that you can version &quot;anything&quot;, not only JSON document but also any values.  As I said before, this is one possible approach, and like any design, it has some impact on the application or database, in this case most the database:</p><ul><li>Increase the number of keys and documents</li><li>Double - or more- the number of operations, for example when updating a document, the application needs to get the current value, create a version, save the current version.</li><li>Consistency management when adding new version and incrementing the version number (need to deal with errors when creating a new version, deleting the versions and counter....)</li></ul><p>Many features could be added to this easily, for example:</p><ul><li>Limit to a specific number of version,</li><li>Enable the versioning only of replace() operation</li><li>Add specific attribute about versions in JSON document (for example date of the version)</li><li>....</li></ul><p>If you are using versioning in your Couchbase application feel free to comment or write a small article that describes the way your are doing it.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2013/10/01/pagination-with-couchbase"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Pagination with Couchbase</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2013/07/11/deploy-your-node-slash-couchbase-application-to-the-cloud-with-clever-cloud"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Deploy your Node/Couchbase application to the cloud with Clever Cloud Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#design" class="table-of-contents__link">Design</a></li><li><a href="#implementing-the-versioning" class="table-of-contents__link">Implementing the versioning</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCA1kgHJTFZW-MRcr8KX_QYQ" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/tugdualgrall/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2003 - 2021 Tugdual Grall built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4098db9b.js"></script>
<script src="/assets/js/main.4630fbc5.js"></script>
</body>
</html>