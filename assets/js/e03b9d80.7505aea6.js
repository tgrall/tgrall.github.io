"use strict";(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[26790],{3905:(e,t,i)=>{i.d(t,{Zo:()=>p,kt:()=>d});var a=i(67294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function l(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,a)}return i}function r(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?l(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function o(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},l=Object.keys(e);for(a=0;a<l.length;a++)i=l[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)i=l[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var s=a.createContext({}),c=function(e){var t=a.useContext(s),i=t;return e&&(i="function"==typeof e?e(t):r(r({},t),e)),i},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var i=e.components,n=e.mdxType,l=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(i),d=n,m=u["".concat(s,".").concat(d)]||u[d]||h[d]||l;return i?a.createElement(m,r(r({ref:t},p),{},{components:i})):a.createElement(m,r({ref:t},p))}));function d(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var l=i.length,r=new Array(l);r[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:n,r[1]=o;for(var c=2;c<l;c++)r[c]=i[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,i)}u.displayName="MDXCreateElement"},65196:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>o,toc:()=>c});var a=i(87462),n=(i(67294),i(3905));const l={title:"Simple caching service with Redis",tags:["nosql","redis","microservices"]},r=void 0,o={permalink:"/blog/2020/05/16/simple-caching-service-with-redis",editUrl:"https://github.dev/tgrall/tgrall.github.io/blob/main/blog/2020-05-16-simple-caching-service-with-redis.md",source:"@site/blog/2020-05-16-simple-caching-service-with-redis.md",title:"Simple caching service with Redis",description:"One of the most common use cases for Redis is to use it the database as a caching layer for your data, but Redis can do a lot more (I will publish new articles later)!",date:"2020-05-16T00:00:00.000Z",formattedDate:"May 16, 2020",tags:[{label:"nosql",permalink:"/blog/tags/nosql"},{label:"redis",permalink:"/blog/tags/redis"},{label:"microservices",permalink:"/blog/tags/microservices"}],readingTime:6.795,hasTruncateMarker:!0,authors:[],frontMatter:{title:"Simple caching service with Redis",tags:["nosql","redis","microservices"]},prevItem:{title:"How to Write Custom GitHub Action (Part 1)",permalink:"/blog/2021/10/30/how-to-write-a-github-action"},nextItem:{title:"How to use SSL/TLS with Redis Enterprise",permalink:"/blog/2020/01/02/how-to-use-ssl-slash-tls-with-redis-enterprise"}},s={authorsImageUrls:[]},c=[{value:"Architecture Overview",id:"architecture-overview",level:3},{value:"Implementation",id:"implementation",level:3},{value:"Data Structure",id:"data-structure",level:4},{value:"Code",id:"code",level:4},{value:"Setting &amp; Getting the OMDb API Key",id:"setting--getting-the-omdb-api-key",level:4},{value:"Calling OMDb API and Caching (or not) the result",id:"calling-omdb-api-and-caching-or-not-the-result",level:4},{value:"Running the application",id:"running-the-application",level:3},{value:"Cloning and Building",id:"cloning-and-building",level:4},{value:"Running the application",id:"running-the-application-1",level:4},{value:"Conclusion",id:"conclusion",level:3}],p={toc:c};function h(e){let{components:t,...l}=e;return(0,n.kt)("wrapper",(0,a.Z)({},p,l,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("img",{src:i(6053).Z,width:"1037",height:"464"})),(0,n.kt)("p",null,"One of the most common use cases for Redis is to use it the database as a caching layer for your data, but Redis can do a lot more ",(0,n.kt)("em",{parentName:"p"},"(I will publish new articles later)"),"!"),(0,n.kt)("p",null,"In this article, you will learn using a straightforward service, how to cache the result on some REST API calls to accelerate the data access, and also reduce the number of calls to external services."),(0,n.kt)("p",null,'For this example, I am using the "Redis Movie Database" application, a microservice-based application that I created to showcase and explain various features of Redis and Redis Enterprise. '),(0,n.kt)("p",null,"You can see the caching service in action in this video:"),(0,n.kt)("iframe",{width:"675",height:"380",src:"https://www.youtube.com/embed/2X6hmXGbLbg",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:!0}),(0,n.kt)("h3",{id:"architecture-overview"},"Architecture Overview"),(0,n.kt)("p",null,'The application uses a third party API provided by the "',(0,n.kt)("a",{parentName:"p",href:"http://www.omdbapi.com/"},"OMDb API"),'" to retrieve the ratings of the movie using its IMDb identifier. The frontend application call the ',(0,n.kt)("inlineCode",{parentName:"p"},"/caching/rating/")," service to get the rating information from OMDB."),(0,n.kt)("p",null,"This service is doing the following:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Check if the rating data is already cached retrieve from the cache"),(0,n.kt)("li",{parentName:"ol"},"If the information is not cached, the system calls the OMDB API with the proper key and Movie ID"),(0,n.kt)("li",{parentName:"ol"},"The result is cached in Redis with a time to live of 120 seconds"),(0,n.kt)("li",{parentName:"ol"},"The ratings are returned to the client.")),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Prerequisites")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Redis 5.x or later."),(0,n.kt)("li",{parentName:"ul"},"Java 8 or later"),(0,n.kt)("li",{parentName:"ul"},"Apache Maven 3.6"),(0,n.kt)("li",{parentName:"ul"},"Git")),(0,n.kt)("h3",{id:"implementation"},"Implementation"),(0,n.kt)("p",null,"In the microservice demonstration project, you can find the caching service in the project below:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/tgrall/redis-microservices-demo/tree/master/caching-service"},"Caching Service"))),(0,n.kt)("p",null,"The Spring Boot application exposes a REST endpoint ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/tgrall/redis-microservices-demo/blob/master/caching-service/src/main/java/io/redis/demos/services/caching/RestStatusController.java"},"RestStatusController.java")," with the following key features:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"/api/1.0/caching/configuration/omdb_api")," : to save the OMDb API key in Redis."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"/api/1.0/caching/ratings/{id}")," : to retrieve the IMDB Rating information.")),(0,n.kt)("h4",{id:"data-structure"},"Data Structure"),(0,n.kt)("p",null,"The Caching Service is pretty simple and using two sets of keys:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"ms:config"),": is a Redis Hash that will be used to store all global configuration; for the caching service, the entry ",(0,n.kt)("inlineCode",{parentName:"li"},"OMDB_API_KEY")," will contain the OMDb API key."),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"ms:cache:ws:*")," : one entry for each movie viewed by a user, where the IMDb movie id replaces the ",(0,n.kt)("inlineCode",{parentName:"li"},"*"),'. The hash contains the ratings, and each of the Movie Rating sites is a key in the hash ("Internet Movie Database",  "Rotten Tomatoes", "Metacritic"), and the value is the rating itself.')),(0,n.kt)("h4",{id:"code"},"Code"),(0,n.kt)("p",null,"The implementation of the caching layer is simple and located in the class below:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/tgrall/redis-microservices-demo/blob/master/caching-service/src/main/java/io/redis/demos/services/caching/service/WebServiceCachingService.java"},(0,n.kt)("inlineCode",{parentName:"a"},"WebServiceCachingService")))),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Getting the Redis Connection")),(0,n.kt)("p",null,"In this project, I have not used Redis/Spring integration ",(0,n.kt)("em",{parentName:"p"},"by choice"),", I am only using Spring injection and Spring Boot Web features."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"the ",(0,n.kt)("inlineCode",{parentName:"li"},"afterConstruct()")," method creates the JedisPool from the Spring Configuration"),(0,n.kt)("li",{parentName:"ul"},"then each time a connection is needed, the application calls ",(0,n.kt)("inlineCode",{parentName:"li"},"Jedis jedis = jedisPool.getResource()")," to get a connection from the pool.")),(0,n.kt)("h4",{id:"setting--getting-the-omdb-api-key"},"Setting & Getting the OMDb API Key"),(0,n.kt)("p",null,"As you have seen earlier, the OMDb API Key is stored in a hash associated with the Redis key ",(0,n.kt)("inlineCode",{parentName:"p"},"ms:config"),"."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The method ",(0,n.kt)("inlineCode",{parentName:"li"},"saveOMDBAPIKey")," is used to store the configuring with a  ",(0,n.kt)("inlineCode",{parentName:"li"},"hset")," call.")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},"    jedis = jedisPool.getResource();\n    jedis.hset(KEY_CONFIG, OMDB_API_KEY, key);\n    omdbAPIKEY = key;\n")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"line 1: get the connection from the pool"),(0,n.kt)("li",{parentName:"ul"},"line 2: set the key in the hash *(as you can see the application uses static variables (",(0,n.kt)("inlineCode",{parentName:"li"},"KEY_CONFIG")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"OMDB_API_KEY"),")"),(0,n.kt)("li",{parentName:"ul"},"line 3: the key received as a method parameter is set to a class member ",(0,n.kt)("inlineCode",{parentName:"li"},"omdbAPIKEY")," to avoid calling the hash each time.")),(0,n.kt)("h4",{id:"calling-omdb-api-and-caching-or-not-the-result"},"Calling OMDb API and Caching (or not) the result"),(0,n.kt)("p",null,"The method ",(0,n.kt)("inlineCode",{parentName:"p"},"getRatings")," receives two parameters:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"imdbId")," the IMDb id"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},"withCache")," a boolean value to use or not Redis. The goal here is to show as a demonstration of the benefits of using Redis.")),(0,n.kt)("p",null,"Let's now look at the code:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-java"},' String restCallKey = KEY_PREFIX + imdbId;\n\n        try (Jedis jedis = jedisPool.getResource()) {\n\n            // Look in the map to see if the value has been cached\n            if (withCache) {\n                returnValue = jedis.hgetAll(restCallKey);\n            }\n\n            if (returnValue.isEmpty()) {\n                returnValue.put("imdb_id", imdbId);\n                CloseableHttpClient httpClient = HttpClientBuilder.create().build();\n                HttpGet getRequest = new HttpGet(url);\n                getRequest.addHeader("accept", "application/json");\n                ResponseHandler<String> responseHandler = new BasicResponseHandler();\n\n                String WsCall = httpClient.execute(getRequest, responseHandler);\n\n                Map<String, Object> map = jsonMapper.readValue(WsCall, Map.class);\n                List<Map<String, String>> ratings = (List<Map<String, String>>) map.get("Ratings");\n\n                Map<String, String> ratingAsMap = new HashMap<>();\n                for (Map<String, String> it : ratings) {\n                    ratingAsMap.put(it.get("Source"), it.get("Value"));\n                }\n\n                returnValue.putAll(ratingAsMap);\n\n                jedis.hset(restCallKey, returnValue);\n                jedis.expire(restCallKey, TTL);\n            }\n\n        } catch(HttpResponseException e){\n            // Small hack to keep it simple\n            returnValue.put("Metacritic", "<p style=\'color:red\'>Error: OMDBAPI Key is invalid -- see services page</p>");\n            omdbAPIKEY = null;\n\n        } catch (IOException e) {\n            e.printStackTrace();\n        }\n    } else {\n        // Small hack to keep it simple\n        returnValue.put("Metacritic", "<p style=\'color:red\'>Error: OMDBAPI Key is not set, please configure it -- see services page</p>");\n    }\n    long end = System.currentTimeMillis();\n    returnValue.put("elapsedTimeMs", Long.toString(end - start) );\n    return returnValue;\n')),(0,n.kt)("p",null,"So if you look in the code carefully you see that only a few lines are related to the cache itself:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Line 1, the key is created from a prefix and the IMDb identifier."),(0,n.kt)("li",{parentName:"ul"},"Line 3, the application retrieves a connection from the Jedis Pool."),(0,n.kt)("li",{parentName:"ul"},"Line 7, if the cache is enabled,  the connection to get the value from Redis ",(0,n.kt)("inlineCode",{parentName:"li"},"returnValue = jedis.hgetAll(restCallKey)")),(0,n.kt)("li",{parentName:"ul"},"If a value is present in the cache, the value is returned to the caller"),(0,n.kt)("li",{parentName:"ul"},"If ",(0,n.kt)("inlineCode",{parentName:"li"},"returnValue")," is empty,  the OMDB REST service must be called (lines 11 to 25)"),(0,n.kt)("li",{parentName:"ul"},"The result of the Web service call is stored in the ",(0,n.kt)("inlineCode",{parentName:"li"},"returnValue")," variable, and save into Redis with a time to live (TTL) of 120 seconds (Line 27 to 29)"),(0,n.kt)("li",{parentName:"ul"},"Finally, the value is returned to the caller (Line 47).")),(0,n.kt)("p",null,"Quite simple, no?"),(0,n.kt)("p",null,"It is possible to optimize a little bit the application/code with few additions:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Make the TTL configurable by adding a new entry in the ",(0,n.kt)("inlineCode",{parentName:"li"},"ms:config")," cache"),(0,n.kt)("li",{parentName:"ul"},"Use ",(0,n.kt)("a",{parentName:"li",href:"https://redis.io/topics/pipelining"},"pipelining")," to reduce the round trip time (RTT)")),(0,n.kt)("h3",{id:"running-the-application"},"Running the application"),(0,n.kt)("p",null,"In the project, the service connects to a ",(0,n.kt)("inlineCode",{parentName:"p"},"local")," instance of Redis on port ",(0,n.kt)("inlineCode",{parentName:"p"},"6379"),". If you want to use a different instance or configure a password/user, you have to edit the ",(0,n.kt)("inlineCode",{parentName:"p"},"/redis-microservices-demo/caching-service/application.properties"),"."),(0,n.kt)("h4",{id:"cloning-and-building"},"Cloning and Building"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"> git clone https://github.com/tgrall/redis-microservices-demo.git\n\n> cd redis-microservices-demo/caching-service\n\n> mvn clean package\n\n")),(0,n.kt)("h4",{id:"running-the-application-1"},"Running the application"),(0,n.kt)("p",null,"The application is a Spring Boot application, run the following command to start it:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"> mvn spring-boot:run\n")),(0,n.kt)("p",null,"Then you should save your ",(0,n.kt)("a",{parentName:"p",href:"https://www.patreon.com/join/omdb"},"OMDB API key")," in Redis using the following call:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"> curl -X POST http://localhost:8084/api/1.0/caching/configuration/omdb_api\\?key\\=[YOUR_KEY]\n")),(0,n.kt)("p",null,'Now you can call the service itself to retrieve the ratings of the movie "WarGames"'),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"> curl -X GET http://localhost:8084/api/1.0/caching/ratings/tt0086567\n")),(0,n.kt)("p",null,'Call it multiple times, and you will see that the first call is *slow" (100ms or more). Then subsequent requests will be a lot faster, as the data are coming out of Redis. After tow minutes, the data is removed from the cache automatically (expiration), and the OMDB service will be called again.'),(0,n.kt)("p",null,"You can also force the service to no use the cache using the following call:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},"> curl -X GET http://localhost:8084/api/1.0/caching/ratings/tt0086567?cache=0\n")),(0,n.kt)("h3",{id:"conclusion"},"Conclusion"),(0,n.kt)("p",null,'The pattern used here is called "Cache-Aside"; and usually pretty easy to implement. It is interesting to notice that many libraries such as Spring provide built-in features to implement such caches.'),(0,n.kt)("p",null,"That said, this is not a silver bullet, you still have to look at the following points when you are implementing such caching service:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Loading the cache: in the example, the cache is populated when the service is called. This lazy loading approach is excellent since the cache is only filled with data that are used by the application. However, the first call is paying the price of higher latency, so on your application, you may require to load the data at startup to avoid any hit miss."),(0,n.kt)("li",{parentName:"ul"},"Cache Invalidation and Lifetime: When caching data, it is essential to look at the invalidation strategy, when and how I can update the data in the cache, but also how long the data will stay in the cache. In the example above, each data will remain for two minutes. ")),(0,n.kt)("p",null,"So now you are all set to implement a simple cache and have consistent fast access to your application data, independently of the backend."))}h.isMDXComponent=!0},6053:(e,t,i)=>{i.d(t,{Z:()=>a});const a=i.p+"assets/images/001-ws-caching-17e9d285eeeee51179e053492aa144b9.png"}}]);