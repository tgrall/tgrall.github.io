<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Tug&#39;s Site Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Tug&#39;s Site Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-1520374-2","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Couchbase 101: Create views (MapReduce) from your Java application | Tug&#x27;s Site</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://tgrall.github.io/blog/2012/12/30/couchbase-101-create-views-mapreduce-from-your-java-application"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Couchbase 101: Create views (MapReduce) from your Java application | Tug&#x27;s Site"><meta data-react-helmet="true" name="description" content="When you are developing a new applications with Couchbase 2.0, you sometimes need to create view dynamically from your code. For example you may need this when you are installing your application, writing some test, or you can also use that when you are building frameworks, and wants to dynamically create views to query data. This post shows how to do it."><meta data-react-helmet="true" property="og:description" content="When you are developing a new applications with Couchbase 2.0, you sometimes need to create view dynamically from your code. For example you may need this when you are installing your application, writing some test, or you can also use that when you are building frameworks, and wants to dynamically create views to query data. This post shows how to do it."><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2012-12-30T00:00:00.000Z"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tgrall.github.io/blog/2012/12/30/couchbase-101-create-views-mapreduce-from-your-java-application"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/2012/12/30/couchbase-101-create-views-mapreduce-from-your-java-application" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tgrall.github.io/blog/2012/12/30/couchbase-101-create-views-mapreduce-from-your-java-application" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.acbe81c6.css">
<link rel="preload" href="/assets/js/runtime~main.564067c1.js" as="script">
<link rel="preload" href="/assets/js/main.7caf5907.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Tug&#x27;s Site</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/talks">Talks</a></div><div class="navbar__items navbar__items--right"><a href="https://windr.org" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Windsurfing App<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/tgrall/tgrall.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/10/30/how-to-write-a-github-action">How to Write Custom GitHub Action (Part 1/2)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/05/16/simple-caching-service-with-redis">Simple caching service with Redis</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2020/01/02/how-to-use-ssl-slash-tls-with-redis-enterprise">How to use SSL/TLS with Redis Enterprise</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2019/09/19/redis-rolling-upgrade-on-pivotal-cloud-foundry-pcf">Redis Rolling Upgrade on Pivotal Cloud Foundry (PCF)</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2019/09/04/multi-nodes-redis-cluster-with-docker">Multi-Nodes Redis Cluster with Docker</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Couchbase 101: Create views (MapReduce) from your Java application</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2012-12-30T00:00:00.000Z" itemprop="datePublished">December 30, 2012</time> Â· 6 min read</div></header><div class="markdown" itemprop="articleBody"><p>When you are developing a new applications with Couchbase 2.0, you sometimes need to create view dynamically from your code. For example you may need this when you are installing your application, writing some test, or you can also use that when you are building frameworks, and wants to dynamically create views to query data. This post shows how to do it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="prerequisites"></a>Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">#</a></h3><ul><li><a href="http://www.couchbase.com/download" target="_blank" rel="noopener noreferrer">Couchbase Server 2.0</a></li><li><a href="http://www.couchbase.com/develop/java/current" target="_blank" rel="noopener noreferrer">Couchbase Jave Client Library 1.1.x</a></li><li><a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-sampledata-beer.html" target="_blank" rel="noopener noreferrer">Beer Sample dataset</a></li></ul><p>If you are using Maven you can use the following information in your <code>pom.xml</code> to add the Java Client library:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly xml"><pre tabindex="0" class="prism-code language-xml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repositories</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">id</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">Couchbase Maven Repository</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">name</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">layout</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">default</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">layout</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">http://files.couchbase.com/maven2/</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">url</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">snapshots</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">enabled</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">false</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">enabled</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">snapshots</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repository</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">repositories</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">couchbase-client</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactid</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.1.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">type</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jar</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">type</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependencies</span><span class="token tag punctuation" style="color:#393A34">&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>See online at <a href="https://gist.github.com/4337172" target="_blank" rel="noopener noreferrer">https://gist.github.com/4337172</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="create-and-manage-views-from-java"></a>Create and Manage Views From Java<a class="hash-link" href="#create-and-manage-views-from-java" title="Direct link to heading">#</a></h3><p>The full Maven project is available on <a href="https://github.com/tgrall/couchbase-java-101/tree/master/java-document-design/" target="_blank" rel="noopener noreferrer">Github</a>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="connect-to-couchbase-cluster"></a>Connect to Couchbase Cluster<a class="hash-link" href="#connect-to-couchbase-cluster" title="Direct link to heading">#</a></h4><p>The first thing to do when you want to create a view from Java is obviously to connect to the cluster.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import com.couchbase.client.CouchbaseClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">List&lt;uri&gt; uris = new LinkedList&lt;uri&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uris.add(URI.create(&quot;http://127.0.0.1:8091/pools&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">CouchbaseClient client = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client = new CouchbaseClient(uris, &quot;beer-sample&quot;, &quot;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // put your code here</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  client.shutdown();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.err.println(&quot;Error connecting to Couchbase: &quot; + e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.exit(0);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ol><li>Create a list of URIs to different nodes of the cluster - lines 5-6. (In this example I am working on a single node)</li><li>Connect to the bucket, in our case <code>beer-sample</code> -line 9. You can include the password if the bucket is protected ( this is not the case here so I am sending an empty string)</li></ol><p>If you are looking for more information about Couchbase and Java, you can read this article from DZone : <a href="http://architects.dzone.com/articles/hello-world-couchbase-and-java" target="_blank" rel="noopener noreferrer">Hello World with Couchbase and Java</a>.</p><p>Let&#x27;s now talk about Couchbase views. You use views/map-reduce functions to index and query data from Couchbase Server based on the content of the JSON document you store inside Couchbase. For more information about views you can look at the <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-basics.html" target="_blank" rel="noopener noreferrer">&quot;view basics&quot; chapter</a> of the Couchbase Server Manual.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="create-views-from-java"></a>Create Views from Java<a class="hash-link" href="#create-views-from-java" title="Direct link to heading">#</a></h4><p>Creating a view from Java is really easy : the Java Client Library contains all the classes and methods to do it. As a concrete use case we will use the Application that is described in the <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/tutorial.html" target="_blank" rel="noopener noreferrer">Couchbase Java Tutorial</a>.</p><p>When you follow this tutorial, you need to manually create some views, as you can see <a href="http://www.couchbase.com/docs/couchbase-sdk-java-1.1/preps-views.html" target="_blank" rel="noopener noreferrer">here</a>. In this example, we will create our map function and directly in our Java code and then store it to Couchbase Server. The tutorial asks you to create the following artifacts:</p><ul><li>a view named &quot;by_name&quot;</li><li>in the design document named <code>&quot;dev_beer&quot;</code> (development mode)</li><li>and the map function which looks like the following :</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly js"><pre tabindex="0" class="prism-code language-js codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">doc</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> meta</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;beer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">emit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword null nil" style="color:#00009f">null</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following code allows you to do it from Java:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import com.couchbase.client.protocol.views.DesignDocument;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.couchbase.client.protocol.views.ViewDesign;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">DesignDocument designDoc = new DesignDocument(&quot;dev_beer&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String viewName = &quot;by_name&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">String mapFunction =</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;function (doc, meta) {\n&quot; +</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  if(doc.type &amp;&amp; doc.type == \&quot;beer\&quot;) {\n&quot; +</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;    emit(doc.name);\n&quot; +</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;  }\n&quot; +</span></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;}&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ViewDesign viewDesign = new ViewDesign(viewName,mapFunction);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">designDoc.getViews().add(viewDesign);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">client.createDesignDoc( designDoc );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>Create a design document using the <code>com.couchbase.client.protocol.views.DesignDocument</code> class - line 4.</li><li>Create a view using <code>com.couchbase.client.protocol.views.ViewDesign</code> class with a name and the map function - line 14.</li><li>You can add this view to a design document - line 15</li><li>Finally save the document into the cluster using the <code>CouchbaseClient.createDesignDoc</code> method.</li></ul><p>If you need to use a reduce function (built-in or custom) you just need to pass to the ViewDesign constructor as 3rd parameter.</p><p>When developing view, from Java or from any other tool/language be sure you understand what are the best practices, and the life cycle of the index. This is why I am inviting you to take a look to the following chapters in the Couchbase documentation:</p><ul><li><a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-writing-bestpractice.html" target="_blank" rel="noopener noreferrer">View Writing Best Practice</a> : for example in the map function, I do not emit any value. I only emit a key (the beer name).</li><li><a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-datastore.html" target="_blank" rel="noopener noreferrer">Views and Stored Data</a></li><li><a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-types.html" target="_blank" rel="noopener noreferrer">Development and Production Views</a> : in the view above, I have created the view in the development environment (<code>dev_</code> prefix) allowing me to test and use it on a subset of the data (cluster/index)</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor anchor__h4 anchorWithStickyNavbar_31ik" id="using-the-view"></a>Using the view<a class="hash-link" href="#using-the-view" title="Direct link to heading">#</a></h4><p>First of all, the view that you just created is in &quot;development mode&quot;, and by default the Java client SDK will only access the view when it is in &quot;production mode&quot;. This means that when you are calling a view from your application it will search it into the production environment. So before connecting to Couchbase cluster you need to setup the <code>viewmode</code> to development.</p><p>This is done using the <code>viewmode</code> environment variable from the Java SDK, that could be set using the following methods:</p><ul><li>In your code, add this line <strong>before</strong> the client connects to the cluster : <code>System.setProperty(&quot;viewmode&quot;, &quot;development&quot;);</code></li><li>At the command line <code>-Dviewmode=development</code></li><li>In a properties file <code>viewmode=development</code></li></ul><p>Once it is done you can call the view using the following code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><pre tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">import import com.couchbase.client.protocol.views.*;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">System.setProperty(&quot;viewmode&quot;, &quot;development&quot;); // before the connection to Couchbase</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span><span class="token-line" style="color:#393A34"><span class="token plain">View view = client.getView(&quot;beer&quot;, &quot;by_name&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Query query = new Query();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">query.setIncludeDocs(true).setLimit(20);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">query.setStale( Stale.FALSE );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">ViewResponse result = client.query(view, query);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">for(ViewRow row : result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  row.getDocument(); // deal with the document/data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This code queries the view you just created. This means Couchbase Server will generate an index based on your map function, will query the server for results. In this case, we specifically want to set a limit of 20 results and also get the most current results by setting Stale.FALSE.</p><ul><li>Set the <code>viewmode</code> to <code>development</code> - line 4</li><li>Get the view using the <code>CouchbaseClient.getView()</code> method -line 6-. As you can see I just use the name beer for the design document (and not dev_beer, Couchbase will know where to search since I am in development mode)</li><li>Create a query and set a limit (20) and ask the SDK to return the document itself
<code>setIncludeDocs(true)</code> -line 8- The document will be returned from Couchbase server in the most efficient way</li><li>Ask the system to update the index before returning the result using query.setStale( Stale.FALSE <code>); </code>-line 9-. Once again be careful when you use setStale method. Just to be sure here is the documentation about it : <a href="http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-writing-stale.html" target="_blank" rel="noopener noreferrer">Index Updates and the stale Parameter</a></li><li>Execute the query - line 10</li><li>And use the result - lines 11-13</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>In this article, you have learned:</p><ul><li>How to create Couchbase views from Java</li><li>Call this view from Java</li><li>Configure development/production mode views from Couchbase Java Client Library</li></ul><p>This example is limited to the creation of a view, you can take a look to the other methods related to design documents and views if you want to manage your design documents : <code>getDesignDocument()</code>, <code>deleteDesignDocument()</code>, ...</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2013/01/04/getting-started-with-couchbase-and-node-dot-js-on-windows"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Getting started with Couchbase and node.js on Windows</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2012/12/26/what-to-do-if-your-couchbase-server-does-not-start"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">What to do if your Couchbase Server does not start? Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prerequisites" class="table-of-contents__link">Prerequisites</a></li><li><a href="#create-and-manage-views-from-java" class="table-of-contents__link">Create and Manage Views From Java</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.linkedin.com/in/tugdualgrall/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.instagram.com/tgrall/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Instagram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/tgrall" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2003 - 2021 Tugdual Grall built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.564067c1.js"></script>
<script src="/assets/js/main.7caf5907.js"></script>
</body>
</html>