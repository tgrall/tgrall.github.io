(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[94255],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return c},kt:function(){return h}});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var i=a.createContext({}),p=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(i.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(t),h=o,m=d["".concat(i,".").concat(h)]||d[h]||u[h]||r;return t?a.createElement(m,l(l({ref:n},c),{},{components:t})):a.createElement(m,l({ref:n},c))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,l=new Array(r);l[0]=d;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s.mdxType="string"==typeof e?e:o,l[1]=s;for(var p=2;p<r;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},13159:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return i},metadata:function(){return p},assets:function(){return c},toc:function(){return u},default:function(){return h}});var a=t(22122),o=t(19756),r=(t(67294),t(3905)),l=["components"],s={title:"Create a Simple Node.js and Couchbase application... on OS X",categories:"nodejs javascript couchbase nosql"},i=void 0,p={permalink:"/blog/2012/09/24/create-a-simple-node-dot-js-and-couchbase-application-dot-dot-dot-on-os-x",editUrl:"https://github.dev/tgrall/tgrall.github.io/blob/main/blog/2012-09-24-create-a-simple-node-dot-js-and-couchbase-application-dot-dot-dot-on-os-x.md",source:"@site/blog/2012-09-24-create-a-simple-node-dot-js-and-couchbase-application-dot-dot-dot-on-os-x.md",title:"Create a Simple Node.js and Couchbase application... on OS X",description:"NOTE: The Couchbase Node.js Client Library is currently changing. I will update this article and source code once the API is stable.",date:"2012-09-24T00:00:00.000Z",formattedDate:"September 24, 2012",tags:[],readingTime:6.785,truncated:!0,authors:[],prevItem:{title:"Couchbase : Create a large dataset using Twitter and Java",permalink:"/blog/2012/11/05/couchbase-create-a-large-dataset-using-twitter-and-java"},nextItem:{title:"Couchbase 101 : install, store and query data",permalink:"/blog/2012/07/06/couchbase-101-install-store-and-query-data"}},c={authorsImageUrls:[]},u=[{value:"Installation",id:"installation",children:[]},{value:"Coding",id:"coding",children:[]}],d={toc:u};function h(e){var n=e.components,t=(0,o.Z)(e,l);return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"NOTE:")," The Couchbase Node.js Client Library is currently changing. I will update this article and source code once the API is stable.")),(0,r.kt)("p",null,"I am currently playing a little bit with Node.js . It is quite fun! In this article I won't go in a a very complex application but just give you the basic steps to create your first Node.js+Couchbase application... on Mac OS X."),(0,r.kt)("h3",{id:"installation"},"Installation"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Couchbase 2.0 Beta:")),(0,r.kt)("p",null,"You can take a look the first steps of my ",(0,r.kt)("a",{parentName:"p",href:"http://tugdualgrall.blogspot.fr/2012/07/couchbase-101-install-store-and-query.html"},"previous article")," to install Couchbase. The basics steps are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Download ",(0,r.kt)("a",{parentName:"li",href:"http://www.couchbase.com/couchbase-server/beta"},"Couchbase 2. 0 Beta")),(0,r.kt)("li",{parentName:"ul"},'Start the server (Run the "Couchbase Server" application)'),(0,r.kt)("li",{parentName:"ul"},"Configure the server")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Other Components :")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Node.js"),(0,r.kt)("li",{parentName:"ul"},"Couchbase Client Library (C version)")),(0,r.kt)("p",null,"To install these two components I am using homebrew (aka brew)."),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"_Hmmm, what is homebrew?")),(0,r.kt)("p",null,"Homebrew is a package manager for OS X that allows you to install, update and uninstall unix tools using very simple commands. You can find more information on the ",(0,r.kt)("a",{parentName:"p",href:"http://mxcl.github.com/homebrew/"},"homebrew site"),". So let's start by installing homebrew itself."),(0,r.kt)("p",null,"From a terminal window:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},'ruby -e "$(curl -fsSkL raw.github.com/mxcl/homebrew/go)"\n\n')),(0,r.kt)("p",null,"Then let's install node"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"brew install node\n")),(0,r.kt)("p",null,"and finally install Couchbase Client Library"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"brew install https://github.com/couchbase/homebrew/raw/preview/Library/Formula/libcouchbase.rb\n")),(0,r.kt)("h3",{id:"coding"},"Coding"),(0,r.kt)("p",null,"You are now ready to start the development of your application."),(0,r.kt)("h4",{id:"create-a-very-simple-application"},"Create a very simple application"),(0,r.kt)("p",null,"1- Create a folder for your application"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"mkdir sample-app\ncd sample-app\n")),(0,r.kt)("p",null,"2- Create an ",(0,r.kt)("inlineCode",{parentName:"p"},"app.js")," file and copy the following code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'var http = require("http");\n\nfunction onRequest(request, response) {\n  response.writeHead(200, {"Content-Type": "text/plain"});\n  response.write("Hello World");\n  response.end();\n}\n\nvar server = http.createServer(onRequest);\nserver.listen(8080);\n\nconsole.log("&gt; SERVER STARTED");\n')),(0,r.kt)("p",null,"I won't go in all the details about a node application; for this I invite you to read ",(0,r.kt)("a",{parentName:"p",href:"http://www.nodebeginner.org/"},"The Node Beginnger Book"),"."),(0,r.kt)("p",null,"3- Start your server"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"node app.js\n")),(0,r.kt)("p",null,"You should be able to access your application using http://localhost:8080"),(0,r.kt)("p",null,"To stop your server just use ctrl+c."),(0,r.kt)("h4",{id:"install-and-use-couchbase-client-for-nodejs"},"Install and use Couchbase client for node.js"),(0,r.kt)("p",null,"npm is the ",(0,r.kt)("a",{parentName:"p",href:"https://npmjs.org/"},"node package manager"),", that allows you to easily install node.js modules and manage dependencies for your application (I will present the dependency management in another post)"),(0,r.kt)("p",null,"1- Install the Couchbase Client for node.js, using the following command"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"npm install couchbase\n")),(0,r.kt)("p",null,"Couldn't be simpler! You can find more information about Couchbase Client for node on its ",(0,r.kt)("a",{parentName:"p",href:"https://npmjs.org/package/couchbase"},"npm page"),"."),(0,r.kt)("p",null,"2- Lets now insert some data into Couchbase"),(0,r.kt)("p",null,"Create a simple function that inserts some documents, and call it after server startup:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'var http = require("http");\n\n// load the Couchbase driver and connect to the cluster\nvar driver = require(\'couchbase\');\nvar cb = new driver.Couchbase("localhost:8091", null, null, "default");\n\n...\n...\n\nfunction insertData() {\n  // insert employees in Couchbase\n  var emps = [{\n    "type": "employee",\n    "id": 100,\n    "name": "Thomas",\n    "dept": "Sales",\n    "salary": 5000\n    }, {\n      "type": "employee",\n      "id": 200,\n      "name": "John",\n      "dept": "Development",\n      "salary": 4500\n      }, {\n        "type": "employee",\n        "id": 300,\n        "name": "Jane",\n        "dept": "Marketing",\n        "salary": 5000\n        }]\n\n        // Insert the data in Couchbase using the add method ()\n        for (index = 0; index &lt; emps.length; index++) {\n          cb.add(JSON.stringify(emps[index].id), JSON.stringify(emps[index]), 0, undefined, function(data, err, key, cas) {\n            if (err &amp;&amp; err != 12) { // 12 : LCB_KEY_EEXISTS  \n              console.log("Failed to store object:\\n" + err);\n            }\n            });\n          }\n        }\n\n        server.listen(8080, insertData());\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Lines 4-5 : load the Couchbase driver and connect to the server. I am using the complete list of parameter ",(0,r.kt)("inlineCode",{parentName:"li"},'connect("server:port", "username", "password", "bucket"). But you can use the short version '),'connect("server:port")`'),(0,r.kt)("li",{parentName:"ul"},"Lines 12-30 : just create JSON object that will be pushed in Couchbase."),(0,r.kt)("li",{parentName:"ul"},"Line 33 : the application just read each element of the array and insert them into Couchbase using the ",(0,r.kt)("inlineCode",{parentName:"li"},"couchbase.add()")," function."),(0,r.kt)("li",{parentName:"ul"},"Lines 34-38 : the ",(0,r.kt)("inlineCode",{parentName:"li"},"couchbase.add()")," function set the value only if it does not exist. If the value exists the error code LCB_KEY_EEXISTS (12) is return by the callback function")),(0,r.kt)("p",null,"3- Start your server - ",(0,r.kt)("inlineCode",{parentName:"p"},"node app.js")," - and check using the Admin Console that employees are inserted into your Couchbase instance. Note that node.js applications do not support hot deployment, so you need to bounce your application when changing the code."),(0,r.kt)("h4",{id:"create-and-use-couchbase-view"},"Create and use Couchbase View"),(0,r.kt)("p",null,"Let's now create and use a view to return the employee list."),(0,r.kt)("p",null,"1- All Couchbase views are accessible using a simple REST API, but you can also use the node.js plugin : ",(0,r.kt)("a",{parentName:"p",href:"https://npmjs.org/package/baseview"},"baseview"),"; so let's install this module:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"npm install baseview\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Create a new view from your application")),(0,r.kt)("p",null,"You can use the Admin Console to create the view, but it is also possible to do it from your node.js code. So let's add the view programmatically in the insertData function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"var http = require(\"http\");\n\n// load the Couchbase driver and connect to the cluster\nvar driver = require('couchbase');\nvar cb = new driver.Couchbase(\"localhost:8091\", null, null, \"default\");\n// load the baseview module\nvar baseview = require('baseview')({url: 'http://localhost:8092', bucket: 'default'});\n\n...\n...\n\nfunction insertData() {\n\n  //create a new view\n  baseview.setDesign('design_employees', {\n    'basic_list': {\n      'map': \"function (doc, meta) { if(doc.type == 'employee') {emit(meta.id, doc.name);}}\"\n    }\n  },\n  function(err, res){\n    if (err != null) console.log(err);\n  }\n);\n\n...\n\n}\n...\n\n")),(0,r.kt)("p",null,"This new code, create a new view in Couchbase server:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"line 7 : load the module and set the properties to call the view services"),(0,r.kt)("li",{parentName:"ul"},"line 16-17 : call the ",(0,r.kt)("inlineCode",{parentName:"li"},"basevie.setDesign()")," method, that create a view."),(0,r.kt)("li",{parentName:"ul"},"line 18 : set the map function that list all the employees")),(0,r.kt)("p",null,"3- Let's now call the view in the onRequest function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"function onRequest(request, response) {\n  response.writeHead(200, {\n    \"Content-Type\": \"text/plain\"\n  });\n  response.write(\"See list of employees in the console\");\n  var params =\n{ 'descending'  : 'true'\n, 'include_docs' : 'true'\n};\nbaseview.view('design_employees', 'basic_list', params, function(error, data) {\n  for( var i = data.rows.length-1,length = data.rows.length ; i >= 0; i-- ) {\n    var employee = data.rows[i].doc.json;\n    console.log(employee);\n  }\n});\nresponse.end();\n}\n")),(0,r.kt)("p",null,"Calling the view is quite simple :"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"lines 6-8 : create an object to send view parameters. In this example I am just using descending, and include_docs to get the full document as part of the response. You can find the list of all the parameters you can use in the ",(0,r.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-querying-rest-api.html"},"Couchbase documentation : Querying Using the REST API")," (The ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/PatrickHeneise/baseview/blob/master/baseview.js"},"baseview")," module is using REST API to call the views)."),(0,r.kt)("li",{parentName:"ul"},"line 10-14 : just loop on the result content, returned in the data variable, and print the employee information in the console.")),(0,r.kt)("p",null,"Note: Because of the asynchronous nature of node.js, and my lack of experience with node, I was not able to send the list of employee to the HTTP response."),(0,r.kt)("p",null,"In another article I will explain how to integrate Couchbase with an node.js application based on Express and Socket.io, where I list the Employee in my the Web page."),(0,r.kt)("p",null,"Below, the complete code of this simple node.js application:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'var http = require("http");\nvar driver = require(\'couchbase\');\nvar cb = new driver.Couchbase("localhost:8091", null, null, "default");\nvar baseview = require(\'baseview\')({url: \'http://127.0.0.1:8092\',bucket: \'default\'});\n\nfunction onRequest(request, response) {\n  response.writeHead(200, {\n    "Content-Type": "text/plain"\n  });\n  response.write("See list of employees in the console");\n  var params = {\n    \'descending\': \'true\',\n    \'include_docs\': \'true\'\n  };\n  baseview.view(\'design_employees\', \'basic_list\', params, function(error, data) {\n    for (var i = data.rows.length - 1, length = data.rows.length; i >= 0; i--) {\n      var employee = data.rows[i].doc.json;\n      console.log(employee);\n    }\n  });\n  response.end();\n}\n\nfunction insertData() {\n  //create a new view\n  baseview.setDesign(\'design_employees\', {\n    \'basic_list\': {\n      \'map\': "function (doc, meta) { if(doc.type == \'employee\') {emit(meta.id, doc.name);}}"\n    }\n  }, function(err, res) {\n    if (err != null) console.log(err);\n  });\n\n  // insert employees in Couchbase\n  var emps = [{\n    "type": "employee",\n    "id": 100,\n    "name": "Thomas",\n    "dept": "Sales",\n    "salary": 5000\n  }, {\n    "type": "employee",\n    "id": 200,\n    "name": "John",\n    "dept": "Development",\n    "salary": 4500\n  }, {\n    "type": "employee",\n    "id": 300,\n    "name": "Jane",\n    "dept": "Marketing",\n    "salary": 5000\n    }]\n\n\n    // Insert the data in Couchbase using the add method ()\n    for (index = 0; index < emps.length; index++) {\n      cb.add(JSON.stringify(emps[index].id), JSON.stringify(emps[index]), 0, undefined, function(data, err, key, cas) {\n        if (err && err != 12) { // 12 : LCB_KEY_EEXISTS  \n          console.log("Failed to store object:\\n" + err);\n        }\n        });\n      }\n    }\n\n    var server = http.createServer(onRequest);\n\n    server.listen(8080, insertData());\n\n    console.log("> SERVER STARTED");\n')))}h.isMDXComponent=!0}}]);