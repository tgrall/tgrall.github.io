(self.webpackChunktgrall_blog=self.webpackChunktgrall_blog||[]).push([[44745],{3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return u},kt:function(){return p}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),p=o,h=d["".concat(s,".").concat(p)]||d[p]||m[p]||i;return n?a.createElement(h,r(r({ref:t},u),{},{components:n})):a.createElement(h,r({ref:t},u))}));function p(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},73647:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},assets:function(){return u},toc:function(){return m},default:function(){return p}});var a=n(22122),o=n(19756),i=(n(67294),n(3905)),r=["components"],l={title:"Couchbase 101: Create views (MapReduce) from your Java application",categories:"nosql couchbase java"},s=void 0,c={permalink:"/blog/2012/12/30/couchbase-101-create-views-mapreduce-from-your-java-application",editUrl:"https://github.dev/tgrall/tgrall.github.io/blob/main/blog/2012-12-30-couchbase-101-create-views-mapreduce-from-your-java-application.md",source:"@site/blog/2012-12-30-couchbase-101-create-views-mapreduce-from-your-java-application.md",title:"Couchbase 101: Create views (MapReduce) from your Java application",description:"When you are developing a new applications with Couchbase 2.0, you sometimes need to create view dynamically from your code. For example you may need this when you are installing your application, writing some test, or you can also use that when you are building frameworks, and wants to dynamically create views to query data. This post shows how to do it.",date:"2012-12-30T00:00:00.000Z",formattedDate:"December 30, 2012",tags:[],readingTime:5.835,truncated:!1,authors:[],prevItem:{title:"Getting started with Couchbase and node.js on Windows",permalink:"/blog/2013/01/04/getting-started-with-couchbase-and-node-dot-js-on-windows"},nextItem:{title:"What to do if your Couchbase Server does not start?",permalink:"/blog/2012/12/26/what-to-do-if-your-couchbase-server-does-not-start"}},u={authorsImageUrls:[]},m=[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Create and Manage Views From Java",id:"create-and-manage-views-from-java",children:[]},{value:"Conclusion",id:"conclusion",children:[]}],d={toc:m};function p(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"When you are developing a new applications with Couchbase 2.0, you sometimes need to create view dynamically from your code. For example you may need this when you are installing your application, writing some test, or you can also use that when you are building frameworks, and wants to dynamically create views to query data. This post shows how to do it."),(0,i.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/download"},"Couchbase Server 2.0")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/develop/java/current"},"Couchbase Jave Client Library 1.1.x")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-sampledata-beer.html"},"Beer Sample dataset"))),(0,i.kt)("p",null,"If you are using Maven you can use the following information in your ",(0,i.kt)("inlineCode",{parentName:"p"},"pom.xml")," to add the Java Client library:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<repositories>\n  <repository>\n    <id>couchbase</id>\n    <name>Couchbase Maven Repository</name>\n    <layout>default</layout>\n    <url>http://files.couchbase.com/maven2/</url>\n    <snapshots>\n      <enabled>false</enabled>\n    </snapshots>\n  </repository>\n</repositories>\n\n<dependencies>\n  <dependency>\n    <groupid>couchbase</groupid>\n    <artifactid>couchbase-client</artifactid>\n    <version>1.1.0</version>\n    <type>jar</type>\n  </dependency>\n</dependencies>\n")),(0,i.kt)("p",null,"See online at ",(0,i.kt)("a",{parentName:"p",href:"https://gist.github.com/4337172"},"https://gist.github.com/4337172")),(0,i.kt)("h3",{id:"create-and-manage-views-from-java"},"Create and Manage Views From Java"),(0,i.kt)("p",null,"The full Maven project is available on ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/tgrall/couchbase-java-101/tree/master/java-document-design/"},"Github"),"."),(0,i.kt)("h4",{id:"connect-to-couchbase-cluster"},"Connect to Couchbase Cluster"),(0,i.kt)("p",null,"The first thing to do when you want to create a view from Java is obviously to connect to the cluster."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'import com.couchbase.client.CouchbaseClient;\n...\n\nList<uri> uris = new LinkedList<uri>();\nuris.add(URI.create("http://127.0.0.1:8091/pools"));\nCouchbaseClient client = null;\ntry {\n  client = new CouchbaseClient(uris, "beer-sample", "");\n\n  // put your code here\n\n  client.shutdown();\n\n  } catch (Exception e) {\n    System.err.println("Error connecting to Couchbase: " + e.getMessage());\n    System.exit(0);\n  }\n...\n')),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Create a list of URIs to different nodes of the cluster - lines 5-6. (In this example I am working on a single node)"),(0,i.kt)("li",{parentName:"ol"},"Connect to the bucket, in our case ",(0,i.kt)("inlineCode",{parentName:"li"},"beer-sample")," -line 9. You can include the password if the bucket is protected ( this is not the case here so I am sending an empty string)")),(0,i.kt)("p",null,"If you are looking for more information about Couchbase and Java, you can read this article from DZone : ",(0,i.kt)("a",{parentName:"p",href:"http://architects.dzone.com/articles/hello-world-couchbase-and-java"},"Hello World with Couchbase and Java"),"."),(0,i.kt)("p",null,"Let's now talk about Couchbase views. You use views/map-reduce functions to index and query data from Couchbase Server based on the content of the JSON document you store inside Couchbase. For more information about views you can look at the ",(0,i.kt)("a",{parentName:"p",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-basics.html"},'"view basics" chapter')," of the Couchbase Server Manual."),(0,i.kt)("h4",{id:"create-views-from-java"},"Create Views from Java"),(0,i.kt)("p",null,"Creating a view from Java is really easy : the Java Client Library contains all the classes and methods to do it. As a concrete use case we will use the Application that is described in the ",(0,i.kt)("a",{parentName:"p",href:"http://www.couchbase.com/docs/couchbase-sdk-java-1.1/tutorial.html"},"Couchbase Java Tutorial"),"."),(0,i.kt)("p",null,"When you follow this tutorial, you need to manually create some views, as you can see ",(0,i.kt)("a",{parentName:"p",href:"http://www.couchbase.com/docs/couchbase-sdk-java-1.1/preps-views.html"},"here"),". In this example, we will create our map function and directly in our Java code and then store it to Couchbase Server. The tutorial asks you to create the following artifacts:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},'a view named "by_name"'),(0,i.kt)("li",{parentName:"ul"},"in the design document named ",(0,i.kt)("inlineCode",{parentName:"li"},'"dev_beer"')," (development mode)"),(0,i.kt)("li",{parentName:"ul"},"and the map function which looks like the following :")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},'function (doc, meta) {\n  if(doc.type && doc.type == "beer") {\n    emit(doc.name, null);\n  }\n}\n')),(0,i.kt)("p",null,"The following code allows you to do it from Java:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'import com.couchbase.client.protocol.views.DesignDocument;\nimport com.couchbase.client.protocol.views.ViewDesign;\n...\nDesignDocument designDoc = new DesignDocument("dev_beer");\n\nString viewName = "by_name";\nString mapFunction =\n"function (doc, meta) {\\n" +\n"  if(doc.type && doc.type == \\"beer\\") {\\n" +\n"    emit(doc.name);\\n" +\n"  }\\n" +\n"}";\n\nViewDesign viewDesign = new ViewDesign(viewName,mapFunction);\ndesignDoc.getViews().add(viewDesign);\nclient.createDesignDoc( designDoc );\n...\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Create a design document using the ",(0,i.kt)("inlineCode",{parentName:"li"},"com.couchbase.client.protocol.views.DesignDocument")," class - line 4."),(0,i.kt)("li",{parentName:"ul"},"Create a view using ",(0,i.kt)("inlineCode",{parentName:"li"},"com.couchbase.client.protocol.views.ViewDesign")," class with a name and the map function - line 14."),(0,i.kt)("li",{parentName:"ul"},"You can add this view to a design document - line 15"),(0,i.kt)("li",{parentName:"ul"},"Finally save the document into the cluster using the ",(0,i.kt)("inlineCode",{parentName:"li"},"CouchbaseClient.createDesignDoc")," method.")),(0,i.kt)("p",null,"If you need to use a reduce function (built-in or custom) you just need to pass to the ViewDesign constructor as 3rd parameter."),(0,i.kt)("p",null,"When developing view, from Java or from any other tool/language be sure you understand what are the best practices, and the life cycle of the index. This is why I am inviting you to take a look to the following chapters in the Couchbase documentation:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-writing-bestpractice.html"},"View Writing Best Practice")," : for example in the map function, I do not emit any value. I only emit a key (the beer name)."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-datastore.html"},"Views and Stored Data")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-types.html"},"Development and Production Views")," : in the view above, I have created the view in the development environment (",(0,i.kt)("inlineCode",{parentName:"li"},"dev_")," prefix) allowing me to test and use it on a subset of the data (cluster/index)")),(0,i.kt)("h4",{id:"using-the-view"},"Using the view"),(0,i.kt)("p",null,'First of all, the view that you just created is in "development mode", and by default the Java client SDK will only access the view when it is in "production mode". This means that when you are calling a view from your application it will search it into the production environment. So before connecting to Couchbase cluster you need to setup the ',(0,i.kt)("inlineCode",{parentName:"p"},"viewmode")," to development."),(0,i.kt)("p",null,"This is done using the ",(0,i.kt)("inlineCode",{parentName:"p"},"viewmode")," environment variable from the Java SDK, that could be set using the following methods:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"In your code, add this line ",(0,i.kt)("strong",{parentName:"li"},"before")," the client connects to the cluster : ",(0,i.kt)("inlineCode",{parentName:"li"},'System.setProperty("viewmode", "development");')),(0,i.kt)("li",{parentName:"ul"},"At the command line ",(0,i.kt)("inlineCode",{parentName:"li"},"-Dviewmode=development")),(0,i.kt)("li",{parentName:"ul"},"In a properties file ",(0,i.kt)("inlineCode",{parentName:"li"},"viewmode=development"))),(0,i.kt)("p",null,"Once it is done you can call the view using the following code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-java"},'import import com.couchbase.client.protocol.views.*;\n\n...\nSystem.setProperty("viewmode", "development"); // before the connection to Couchbase\n...\nView view = client.getView("beer", "by_name");\nQuery query = new Query();\nquery.setIncludeDocs(true).setLimit(20);\nquery.setStale( Stale.FALSE );\nViewResponse result = client.query(view, query);\nfor(ViewRow row : result) {\n  row.getDocument(); // deal with the document/data\n}\n...\n')),(0,i.kt)("p",null,"This code queries the view you just created. This means Couchbase Server will generate an index based on your map function, will query the server for results. In this case, we specifically want to set a limit of 20 results and also get the most current results by setting Stale.FALSE."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Set the ",(0,i.kt)("inlineCode",{parentName:"li"},"viewmode")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"development")," - line 4"),(0,i.kt)("li",{parentName:"ul"},"Get the view using the ",(0,i.kt)("inlineCode",{parentName:"li"},"CouchbaseClient.getView()")," method -line 6-. As you can see I just use the name beer for the design document (and not dev_beer, Couchbase will know where to search since I am in development mode)"),(0,i.kt)("li",{parentName:"ul"},"Create a query and set a limit (20) and ask the SDK to return the document itself\n",(0,i.kt)("inlineCode",{parentName:"li"},"setIncludeDocs(true)")," -line 8- The document will be returned from Couchbase server in the most efficient way"),(0,i.kt)("li",{parentName:"ul"},"Ask the system to update the index before returning the result using query.setStale( Stale.FALSE ",(0,i.kt)("inlineCode",{parentName:"li"},"); "),"-line 9-. Once again be careful when you use setStale method. Just to be sure here is the documentation about it : ",(0,i.kt)("a",{parentName:"li",href:"http://www.couchbase.com/docs/couchbase-manual-2.0/couchbase-views-writing-stale.html"},"Index Updates and the stale Parameter")),(0,i.kt)("li",{parentName:"ul"},"Execute the query - line 10"),(0,i.kt)("li",{parentName:"ul"},"And use the result - lines 11-13")),(0,i.kt)("h3",{id:"conclusion"},"Conclusion"),(0,i.kt)("p",null,"In this article, you have learned:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"How to create Couchbase views from Java"),(0,i.kt)("li",{parentName:"ul"},"Call this view from Java"),(0,i.kt)("li",{parentName:"ul"},"Configure development/production mode views from Couchbase Java Client Library")),(0,i.kt)("p",null,"This example is limited to the creation of a view, you can take a look to the other methods related to design documents and views if you want to manage your design documents : ",(0,i.kt)("inlineCode",{parentName:"p"},"getDesignDocument()"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"deleteDesignDocument()"),", ..."))}p.isMDXComponent=!0}}]);